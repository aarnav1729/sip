<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sip</title>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.2/babel.min.js"></script>
    <link rel="icon" type="image/svg+xml" href="/l.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* ═══════════════════════════ DESIGN TOKENS ═══════════════════════════ */
      :root {
        /* Backgrounds */
        --bg: #05080f;
        --bg2: #080c16;
        --surface: #0c1120;
        --surface2: #101828;
        --surface3: #151e30;
        --glass: rgba(12, 17, 32, 0.85);

        /* Borders */
        --border: rgba(255, 255, 255, 0.06);
        --border2: rgba(255, 255, 255, 0.1);
        --border3: rgba(255, 255, 255, 0.14);

        /* Text */
        --text: #e8edf8;
        --text2: #8899bb;
        --muted: #4a5a7a;
        --faint: #2a3450;

        /* Accents */
        --teal: #06d6a0;
        --teal-dim: rgba(6, 214, 160, 0.1);
        --teal-glow: rgba(6, 214, 160, 0.2);
        --amber: #ffd166;
        --amber-dim: rgba(255, 209, 102, 0.1);
        --coral: #ef476f;
        --coral-dim: rgba(239, 71, 111, 0.1);
        --violet: #a78bfa;
        --violet-dim: rgba(167, 139, 250, 0.1);
        --sky: #38bdf8;
        --sky-dim: rgba(56, 189, 248, 0.1);

        /* Semantic */
        --success: #06d6a0;
        --danger: #ef476f;
        --warn: #ffd166;

        /* Misc */
        --radius: 12px;
        --radius-sm: 8px;
        --shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
        --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.4);

        /* Rail */
        --rail: 56px;
      }

      [data-theme="light"] {
        --bg: #f0f2f8;
        --bg2: #e8ecf5;
        --surface: #ffffff;
        --surface2: #f5f7fc;
        --surface3: #eef0f8;
        --glass: rgba(255, 255, 255, 0.92);
        --border: rgba(0, 0, 0, 0.07);
        --border2: rgba(0, 0, 0, 0.1);
        --border3: rgba(0, 0, 0, 0.14);
        --text: #0f1728;
        --text2: #3a4a6a;
        --muted: #6a7a9a;
        --faint: #c0cce0;
        --teal: #059669;
        --teal-dim: rgba(5, 150, 105, 0.08);
        --teal-glow: rgba(5, 150, 105, 0.15);
        --amber: #d97706;
        --amber-dim: rgba(217, 119, 6, 0.08);
        --coral: #dc2626;
        --coral-dim: rgba(220, 38, 38, 0.08);
        --violet: #7c3aed;
        --violet-dim: rgba(124, 58, 237, 0.08);
        --sky: #0284c7;
        --sky-dim: rgba(2, 132, 199, 0.08);
        --success: #059669;
        --danger: #dc2626;
        --warn: #d97706;
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      /* ═══════════════════════════ BASE ═══════════════════════════ */
      html,
      body {
        height: 100%;
        background: var(--bg);
        color: var(--text);
        font-family: "DM Sans", sans-serif;
        overflow: hidden;
      }
      html {
        transition: background 0.3s, color 0.3s;
      }
      #root {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border2);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--border3);
      }

      /* ═══════════════════════════ LAYOUT ═══════════════════════════ */
      .shell {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      .rail {
        width: var(--rail);
        min-width: var(--rail);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 0;
        gap: 2px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        z-index: 100;
      }
      .canvas {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg);
      }

      /* ═══════════════════════════ RAIL NAV ═══════════════════════════ */
      .rail-logo {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--teal), var(--sky));
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Syne", sans-serif;
        font-weight: 800;
        font-size: 13px;
        color: #000;
        margin-bottom: 8px;
        flex-shrink: 0;
        cursor: pointer;
        box-shadow: 0 0 20px var(--teal-glow);
        transition: box-shadow 0.3s;
      }
      .rail-logo:hover {
        box-shadow: 0 0 30px var(--teal-glow);
      }

      .rail-btn {
        position: relative;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--muted);
        font-size: 16px;
        transition: background 0.15s, color 0.15s;
        border: 1px solid transparent;
      }
      .rail-btn:hover {
        background: var(--surface2);
        color: var(--text);
      }
      .rail-btn.active {
        background: var(--teal-dim);
        color: var(--teal);
        border-color: rgba(6, 214, 160, 0.2);
      }
      .rail-btn::after {
        content: attr(data-tip);
        position: absolute;
        left: calc(100% + 10px);
        top: 50%;
        transform: translateY(-50%);
        background: var(--surface3);
        border: 1px solid var(--border2);
        color: var(--text);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 6px;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        font-family: "JetBrains Mono", monospace;
        transition: opacity 0.15s;
        z-index: 500;
      }
      .rail-btn:hover::after {
        opacity: 1;
      }
      .rail-divider {
        width: 28px;
        height: 1px;
        background: var(--border);
        margin: 4px 0;
        flex-shrink: 0;
      }
      .rail-spacer {
        flex: 1;
      }
      .rail-theme {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 15px;
        color: var(--muted);
        background: var(--surface2);
        border: 1px solid var(--border);
        transition: all 0.15s;
      }
      .rail-theme:hover {
        color: var(--text);
        border-color: var(--border2);
      }

      /* ═══════════════════════════ TOPBAR ═══════════════════════════ */
      .topbar {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 0 22px;
        height: 52px;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
      }
      .topbar-breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
      }
      .bc-seg {
        color: var(--muted);
        cursor: pointer;
        transition: color 0.15s;
      }
      .bc-seg:hover {
        color: var(--teal);
      }
      .bc-arrow {
        color: var(--faint);
      }
      .bc-active {
        color: var(--teal);
        font-weight: 600;
      }
      .topbar-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }
      .live-pill {
        display: flex;
        align-items: center;
        gap: 6px;
        background: var(--teal-dim);
        border: 1px solid rgba(6, 214, 160, 0.2);
        border-radius: 20px;
        padding: 4px 12px;
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        color: var(--teal);
      }
      .live-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: var(--teal);
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(0.8);
        }
      }

      .report-selector {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .rsel {
        padding: 3px 10px;
        border-radius: 6px;
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        border: 1px solid var(--border);
        color: var(--muted);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s;
      }
      .rsel:hover {
        border-color: var(--border2);
        color: var(--text);
      }
      .rsel.active {
        background: var(--teal);
        color: #000;
        border-color: var(--teal);
        font-weight: 700;
      }

      /* ═══════════════════════════ CONTENT SCROLL ═══════════════════════════ */
      .content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* ═══════════════════════════ HERO STRIP ═══════════════════════════ */
      .hero {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 16px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 22px 26px;
        position: relative;
        overflow: hidden;
      }
      .hero::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          var(--teal),
          var(--sky),
          var(--violet)
        );
      }
      .hero-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 20px;
        align-items: center;
      }
      .hero-main {
      }
      .hero-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 6px;
      }
      .hero-value {
        font-family: "Syne", sans-serif;
        font-size: 40px;
        font-weight: 800;
        letter-spacing: -0.04em;
        line-height: 1;
        color: var(--text);
      }
      .hero-value .hero-unit {
        font-size: 16px;
        color: var(--muted);
        margin-left: 4px;
      }
      .hero-delta {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-top: 8px;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
      }
      .hero-delta.up {
        color: var(--teal);
      }
      .hero-delta.down {
        color: var(--coral);
      }

      .hero-stat {
        border-left: 1px solid var(--border);
        padding-left: 20px;
      }
      .hero-stat .hero-label {
        margin-bottom: 4px;
      }
      .hero-stat .hero-value {
        font-size: 26px;
      }

      .hero-actions {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 10px;
      }

      /* ═══════════════════════════ CARDS GRID ═══════════════════════════ */
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px 20px;
        position: relative;
        overflow: hidden;
        cursor: default;
        transition: border-color 0.2s, background 0.2s, transform 0.15s;
      }
      .card.clickable {
        cursor: pointer;
      }
      .card.clickable:hover {
        border-color: var(--border2);
        background: var(--surface2);
        transform: translateY(-1px);
      }
      .card-accent {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
      }
      .card-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 9px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 10px;
      }
      .card-value {
        font-family: "Syne", sans-serif;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: -0.03em;
        color: var(--text);
        line-height: 1;
      }
      .card-sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .card-badge {
        position: absolute;
        bottom: 12px;
        right: 14px;
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        opacity: 0;
        transition: opacity 0.15s;
        color: var(--faint);
      }
      .card.clickable:hover .card-badge {
        opacity: 1;
      }

      /* ═══════════════════════════ PANEL ═══════════════════════════ */
      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }
      .panel-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        border-bottom: 1px solid var(--border);
        gap: 12px;
        flex-wrap: wrap;
      }
      .panel-title {
        font-family: "Syne", sans-serif;
        font-weight: 700;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .panel-title-dot {
        width: 7px;
        height: 7px;
        border-radius: 2px;
      }
      .panel-body {
        padding: 20px;
      }
      .panel-body.pad0 {
        padding: 0;
      }

      /* ═══════════════════════════ GRID LAYOUTS ═══════════════════════════ */
      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .three-col {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 1100px) {
        .two-col,
        .three-col {
          grid-template-columns: 1fr;
        }
      }

      /* ═══════════════════════════ TABLE ═══════════════════════════ */
      .tbl-wrap {
        overflow-x: auto;
        overflow-y: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12.5px;
      }
      thead th {
        background: var(--surface2);
        padding: 9px 14px;
        font-family: "JetBrains Mono", monospace;
        font-size: 9px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
        border-bottom: 1px solid var(--border);
        text-align: right;
      }
      thead th:first-child,
      thead th:nth-child(2),
      thead th:nth-child(3) {
        text-align: left;
      }
      thead th.sortable {
        cursor: pointer;
        user-select: none;
        transition: color 0.15s;
      }
      thead th.sortable:hover {
        color: var(--text);
      }
      thead th.sort-on {
        color: var(--teal);
      }
      tbody tr {
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        transition: background 0.1s;
      }
      tbody tr:hover {
        background: var(--surface2);
      }
      tbody tr.clickable {
        cursor: pointer;
      }
      td {
        padding: 9px 14px;
        text-align: right;
        color: var(--text2);
        white-space: nowrap;
      }
      td:first-child {
        text-align: left;
        color: var(--muted);
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
      }
      td:nth-child(2) {
        text-align: left;
        font-weight: 600;
        color: var(--text);
      }
      td:nth-child(3) {
        text-align: left;
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
      }
      .td0 {
        color: var(--faint) !important;
      }
      .td-hi {
        color: var(--amber) !important;
        font-weight: 700;
      }
      .td-total {
        font-weight: 700;
        color: var(--text) !important;
        font-family: "JetBrains Mono", monospace;
      }
      tfoot td {
        border-top: 2px solid var(--border2);
        background: var(--surface2);
        padding: 10px 14px;
        font-weight: 700;
        color: var(--text);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
      }
      tfoot td:first-child {
        color: var(--muted);
      }

      /* ═══════════════════════════ WAREHOUSE CARDS ═══════════════════════════ */
      .wh-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 12px;
      }
      .wh-tile {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        cursor: pointer;
        transition: border-color 0.2s, transform 0.15s;
        position: relative;
      }
      .wh-tile:hover {
        border-color: var(--border2);
        transform: translateY(-2px);
      }
      .wh-tile-bar {
        height: 3px;
        width: 100%;
      }
      .wh-tile-body {
        padding: 16px;
      }
      .wh-tile-name {
        font-family: "Syne", sans-serif;
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 3px;
      }
      .wh-tile-val {
        font-family: "JetBrains Mono", monospace;
        font-size: 22px;
        font-weight: 700;
        color: var(--text);
        line-height: 1;
        margin-bottom: 8px;
      }
      .wh-tile-meta {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--muted);
      }
      .wh-tile-share {
        position: absolute;
        top: 16px;
        right: 16px;
        font-family: "JetBrains Mono", monospace;
        font-size: 18px;
        font-weight: 700;
        opacity: 0.15;
        line-height: 1;
      }

      /* ═══════════════════════════ MINI BAR ═══════════════════════════ */
      .mini-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
      }
      .mini-bar-track {
        height: 5px;
        border-radius: 3px;
        background: var(--faint);
        overflow: hidden;
        min-width: 40px;
      }
      .mini-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.4s;
      }
      .mini-bar-val {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        min-width: 56px;
        text-align: right;
      }

      /* ═══════════════════════════ SEARCH & FILTERS ═══════════════════════════ */
      .search-box {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 7px 12px;
        transition: border-color 0.15s;
      }
      .search-box:focus-within {
        border-color: var(--border2);
      }
      .search-box input {
        background: none;
        border: none;
        outline: none;
        color: var(--text);
        font-family: "DM Sans", sans-serif;
        font-size: 13px;
        width: 180px;
      }
      .search-box input::placeholder {
        color: var(--muted);
      }
      .search-icon {
        color: var(--muted);
        font-size: 13px;
      }

      .report-strip {
        display: flex;
        gap: 6px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
      }
      .rchip {
        padding: 4px 12px;
        border-radius: 20px;
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        border: 1px solid var(--border);
        color: var(--muted);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s;
      }
      .rchip:hover {
        border-color: var(--border2);
        color: var(--text);
      }
      .rchip.on {
        background: var(--teal);
        color: #000;
        border-color: var(--teal);
        font-weight: 700;
      }

      /* ═══════════════════════════ BUTTONS ═══════════════════════════ */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        font-family: "DM Sans", sans-serif;
        font-weight: 500;
        transition: all 0.15s;
      }
      .btn-teal {
        background: var(--teal);
        color: #000;
      }
      .btn-teal:hover {
        filter: brightness(1.1);
      }
      .btn-ghost {
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text2);
      }
      .btn-ghost:hover {
        border-color: var(--border2);
        color: var(--text);
      }
      .btn-sm {
        padding: 5px 11px;
        font-size: 11px;
      }
      .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text2);
        border-radius: 8px;
        padding: 7px 14px;
        font-size: 12px;
        cursor: pointer;
        font-family: "DM Sans", sans-serif;
        transition: all 0.15s;
      }
      .btn-back:hover {
        border-color: var(--border2);
        color: var(--text);
      }

      /* ═══════════════════════════ EXPORT ═══════════════════════════ */
      .export-wrap {
        position: relative;
      }
      .export-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 6px);
        background: var(--surface2);
        border: 1px solid var(--border2);
        border-radius: 10px;
        min-width: 180px;
        z-index: 400;
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      .export-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        font-size: 12px;
        color: var(--text2);
        cursor: pointer;
        transition: background 0.1s;
      }
      .export-item:hover {
        background: var(--surface3);
        color: var(--text);
      }

      /* ═══════════════════════════ DRILLDOWN ═══════════════════════════ */
      .drill-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 18px;
      }
      .drill-title {
        font-family: "Syne", sans-serif;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: -0.04em;
        color: var(--text);
      }
      .drill-meta {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
        font-family: "JetBrains Mono", monospace;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 10px;
        margin-bottom: 18px;
      }
      .stat-box {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px 16px;
      }
      .stat-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 9px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.09em;
        margin-bottom: 6px;
      }
      .stat-value {
        font-family: "Syne", sans-serif;
        font-size: 22px;
        font-weight: 800;
        letter-spacing: -0.03em;
        color: var(--text);
      }
      .stat-sub {
        font-size: 11px;
        color: var(--muted);
        margin-top: 3px;
      }

      /* ═══════════════════════════ INTELLIGENCE ═══════════════════════════ */
      .intel-nav {
        display: flex;
        gap: 2px;
        padding: 4px;
        background: var(--surface2);
        border-radius: 10px;
        overflow-x: auto;
      }
      .intel-btn {
        padding: 7px 16px;
        border-radius: 8px;
        cursor: pointer;
        white-space: nowrap;
        font-size: 12px;
        font-family: "JetBrains Mono", monospace;
        color: var(--muted);
        transition: all 0.15s;
      }
      .intel-btn:hover {
        color: var(--text);
      }
      .intel-btn.on {
        background: var(--surface);
        color: var(--teal);
        font-weight: 600;
        box-shadow: var(--shadow-sm);
      }

      .sig-card {
        border-radius: 10px;
        padding: 16px 18px;
        border-left: 3px solid;
        margin-bottom: 10px;
        transition: transform 0.15s;
      }
      .sig-card:hover {
        transform: translateX(3px);
      }
      .sig-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 4px;
      }
      .sig-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 5px;
      }
      .sig-detail {
        font-size: 12px;
        color: var(--text2);
        line-height: 1.5;
      }

      .rec-card {
        border-radius: 10px;
        padding: 18px 20px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        background: var(--surface2);
      }
      .rec-head {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 10px;
      }
      .rec-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text);
      }
      .priority-pill {
        padding: 3px 10px;
        border-radius: 20px;
        font-family: "JetBrains Mono", monospace;
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        white-space: nowrap;
      }
      .rec-rationale {
        font-size: 13px;
        color: var(--text2);
        margin-bottom: 10px;
        line-height: 1.5;
      }
      .rec-action {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 7px;
        padding: 10px 14px;
        font-size: 12px;
        color: var(--text2);
        margin-bottom: 8px;
      }
      .rec-impact {
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        color: var(--muted);
      }

      .conf-bar {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .conf-track {
        flex: 1;
        height: 3px;
        background: var(--faint);
        border-radius: 2px;
        overflow: hidden;
      }
      .conf-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s;
      }
      .conf-pct {
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        color: var(--muted);
        min-width: 28px;
        text-align: right;
      }

      .place-card {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 18px;
        margin-bottom: 12px;
      }
      .place-arrow {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 12px 0;
        flex-wrap: wrap;
      }
      .place-box {
        border-radius: 8px;
        padding: 10px 16px;
        text-align: center;
        border: 1px solid;
      }

      .retro-card {
        border-left: 3px solid;
        border-radius: 9px;
        padding: 14px 18px;
        background: var(--surface2);
        border-top: 1px solid var(--border);
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        margin-bottom: 10px;
      }
      .retro-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .retro-detail {
        font-size: 12px;
        color: var(--text2);
        margin-bottom: 8px;
      }
      .retro-lesson {
        font-size: 11px;
        color: var(--muted);
        padding: 6px 10px;
        background: var(--surface);
        border-radius: 5px;
      }

      .intel-kpi-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
        margin-bottom: 16px;
      }
      .intel-kpi {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 9px;
        padding: 14px 16px;
      }
      .intel-kpi-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 9px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.09em;
        margin-bottom: 6px;
      }
      .intel-kpi-val {
        font-family: "Syne", sans-serif;
        font-size: 26px;
        font-weight: 800;
        letter-spacing: -0.03em;
      }

      .wh-load-row {
        margin-bottom: 12px;
      }
      .wh-load-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }
      .wh-load-name {
        font-size: 12px;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .wh-load-pct {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
      }
      .wh-load-track {
        height: 6px;
        background: var(--faint);
        border-radius: 3px;
        overflow: hidden;
      }
      .wh-load-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s;
      }
      .wh-load-sub {
        display: flex;
        justify-content: space-between;
        margin-top: 3px;
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        color: var(--muted);
      }

      .summary-block {
        background: var(--surface2);
        border: 1px solid var(--border2);
        border-left: 3px solid var(--teal);
        border-radius: 10px;
        padding: 16px 20px;
        font-size: 13.5px;
        line-height: 1.8;
        color: var(--text2);
        margin-bottom: 18px;
      }

      /* ═══════════════════════════ SPARKLINE ROW ═══════════════════════════ */
      .cust-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 8px;
        border-radius: 6px;
        cursor: pointer;
        user-select: none;
        font-size: 12px;
        transition: background 0.1s;
      }
      .cust-chip:hover {
        background: var(--surface2);
      }
      .cust-chip.off {
        opacity: 0.35;
      }
      .chip-dot {
        width: 8px;
        height: 8px;
        border-radius: 2px;
        flex-shrink: 0;
      }
      .chip-name {
        flex: 1;
        color: var(--text2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 12px;
      }
      .chip-val {
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        color: var(--muted);
      }

      /* ═══════════════════════════ WH PILLS ═══════════════════════════ */
      .wh-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .wh-pill {
        padding: 3px 10px;
        border-radius: 5px;
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        border: 1px solid var(--border);
        color: var(--muted);
        cursor: pointer;
        transition: all 0.15s;
      }
      .wh-pill:hover {
        border-color: var(--border2);
        color: var(--text);
      }
      .wh-pill.on {
        border-color: var(--teal);
        color: var(--teal);
        background: var(--teal-dim);
      }

      /* ═══════════════════════════ TOOLTIP ═══════════════════════════ */
      .tt {
        background: var(--surface3);
        border: 1px solid var(--border2);
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 12px;
        box-shadow: var(--shadow);
        min-width: 140px;
      }
      .tt-lbl {
        font-family: "JetBrains Mono", monospace;
        color: var(--muted);
        margin-bottom: 7px;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.07em;
      }
      .tt-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 2px 0;
      }
      .tt-dot {
        width: 7px;
        height: 7px;
        border-radius: 2px;
        flex-shrink: 0;
      }
      .tt-nm {
        color: var(--muted);
        flex: 1;
      }
      .tt-val {
        font-weight: 700;
        color: var(--text);
        font-family: "JetBrains Mono", monospace;
      }

      /* ═══════════════════════════ ANIMATIONS ═══════════════════════════ */
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(14px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideRight {
        from {
          opacity: 0;
          transform: translateX(-12px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 8px var(--teal-glow);
        }
        50% {
          box-shadow: 0 0 20px var(--teal-glow);
        }
      }

      .fade-up {
        animation: fadeUp 0.35s ease both;
      }
      .fade-in {
        animation: fadeIn 0.25s ease both;
      }
      .slide-right {
        animation: slideRight 0.28s ease both;
      }
      .a1 {
        animation-delay: 0.05s;
      }
      .a2 {
        animation-delay: 0.1s;
      }
      .a3 {
        animation-delay: 0.15s;
      }
      .a4 {
        animation-delay: 0.2s;
      }
      .a5 {
        animation-delay: 0.25s;
      }
      .a6 {
        animation-delay: 0.3s;
      }
      .a7 {
        animation-delay: 0.35s;
      }
      .a8 {
        animation-delay: 0.4s;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: var(--muted);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
      }

      /* Forecast table */
      .fc-proj {
        font-family: "Syne", sans-serif;
        font-weight: 700;
        font-size: 13px;
      }
      .fc-delta-up {
        color: var(--teal);
      }
      .fc-delta-dn {
        color: var(--coral);
      }

      @media (max-width: 900px) {
        .rail {
          display: none;
        }
        .hero-grid {
          grid-template-columns: 1fr 1fr;
        }
        .two-col,
        .three-col {
          grid-template-columns: 1fr;
        }
      }

      /* ═══════════════════════════ TUTORIAL SYSTEM ═══════════════════════════ */
      .tut-overlay {
        position: fixed;
        inset: 0;
        z-index: 9000;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.82);
        backdrop-filter: blur(6px);
        animation: fadeIn 0.3s ease;
      }
      .tut-shell {
        width: min(860px, 96vw);
        max-height: 92vh;
        background: var(--surface);
        border: 1px solid var(--border2);
        border-radius: 18px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 24px 80px rgba(0, 0, 0, 0.7),
          0 0 0 1px rgba(6, 214, 160, 0.12);
        animation: tutSlideUp 0.35s cubic-bezier(0.22, 1, 0.36, 1);
      }
      @keyframes tutSlideUp {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .tut-progress-rail {
        height: 3px;
        background: var(--faint);
        flex-shrink: 0;
      }
      .tut-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--teal), var(--sky));
        transition: width 0.4s cubic-bezier(0.22, 1, 0.36, 1);
      }
      .tut-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 26px 14px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .tut-step-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--teal-dim);
        border: 1px solid rgba(6, 214, 160, 0.25);
        border-radius: 20px;
        padding: 4px 14px;
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        color: var(--teal);
        font-weight: 700;
      }
      .tut-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--muted);
        font-size: 18px;
        transition: all 0.15s;
        background: var(--surface2);
      }
      .tut-close:hover {
        border-color: var(--coral);
        color: var(--coral);
      }
      .tut-body {
        flex: 1;
        overflow-y: auto;
        padding: 0;
      }
      .tut-chapter {
        padding: 26px 30px;
      }
      .tut-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        margin-bottom: 18px;
        flex-shrink: 0;
      }
      .tut-eyebrow {
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--teal);
        margin-bottom: 8px;
        font-weight: 700;
      }
      .tut-title {
        font-family: "Syne", sans-serif;
        font-size: 26px;
        font-weight: 800;
        letter-spacing: -0.04em;
        color: var(--text);
        margin-bottom: 10px;
        line-height: 1.15;
      }
      .tut-lead {
        font-size: 14px;
        color: var(--text2);
        line-height: 1.75;
        margin-bottom: 22px;
      }
      .tut-divider {
        height: 1px;
        background: var(--border);
        margin: 22px 0;
      }
      .tut-section-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
        margin-bottom: 12px;
      }
      /* Card grid inside tutorial */
      .tut-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 18px;
      }
      .tut-card {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 11px;
        padding: 14px 16px;
        border-left: 3px solid;
      }
      .tut-card-icon {
        font-size: 20px;
        margin-bottom: 8px;
      }
      .tut-card-title {
        font-size: 13px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 4px;
      }
      .tut-card-desc {
        font-size: 12px;
        color: var(--text2);
        line-height: 1.55;
      }
      /* Formula blocks */
      .tut-formula {
        background: var(--bg);
        border: 1px solid var(--border2);
        border-radius: 10px;
        padding: 14px 18px;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        color: var(--teal);
        margin: 10px 0;
        line-height: 1.7;
      }
      .tut-formula .f-label {
        color: var(--muted);
        font-size: 10px;
        margin-bottom: 6px;
      }
      .tut-formula .f-comment {
        color: var(--muted);
        font-size: 10px;
      }
      /* Decision table */
      .tut-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 8px;
      }
      .tut-table th {
        background: var(--surface2);
        padding: 8px 12px;
        font-family: "JetBrains Mono", monospace;
        font-size: 9px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      .tut-table td {
        padding: 9px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text2);
        text-align: left;
        vertical-align: top;
        line-height: 1.5;
      }
      .tut-table tr:hover td {
        background: var(--surface2);
      }
      /* Classification badges */
      .cls-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 3px 10px;
        border-radius: 20px;
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        font-weight: 700;
        border: 1px solid;
        white-space: nowrap;
      }
      /* Tip block */
      .tut-tip {
        display: flex;
        gap: 12px;
        background: var(--teal-dim);
        border: 1px solid rgba(6, 214, 160, 0.2);
        border-radius: 10px;
        padding: 14px 16px;
        margin-top: 14px;
      }
      .tut-tip-icon {
        font-size: 18px;
        flex-shrink: 0;
        line-height: 1.4;
      }
      .tut-tip-text {
        font-size: 12.5px;
        color: var(--text2);
        line-height: 1.6;
      }
      .tut-tip-text strong {
        color: var(--teal);
      }
      /* Warning block */
      .tut-warn {
        display: flex;
        gap: 12px;
        background: rgba(255, 209, 102, 0.06);
        border: 1px solid rgba(255, 209, 102, 0.2);
        border-radius: 10px;
        padding: 14px 16px;
        margin-top: 14px;
      }
      /* Metric pills row */
      .tut-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }
      .tut-metric {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 14px;
      }
      .tut-metric-dot {
        width: 8px;
        height: 8px;
        border-radius: 2px;
        flex-shrink: 0;
      }
      .tut-metric-label {
        font-family: "JetBrains Mono", monospace;
        font-size: 10px;
        color: var(--text);
        font-weight: 600;
      }
      .tut-metric-def {
        font-size: 11px;
        color: var(--muted);
        margin-left: 4px;
      }
      /* Numbered list */
      .tut-steps {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .tut-step {
        display: flex;
        gap: 14px;
        align-items: flex-start;
      }
      .tut-step-num {
        width: 26px;
        height: 26px;
        border-radius: 7px;
        background: var(--teal-dim);
        border: 1px solid rgba(6, 214, 160, 0.3);
        color: var(--teal);
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: 1px;
      }
      .tut-step-content {
        font-size: 13px;
        color: var(--text2);
        line-height: 1.6;
      }
      .tut-step-content strong {
        color: var(--text);
      }
      /* Footer */
      .tut-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 26px;
        border-top: 1px solid var(--border);
        background: var(--surface2);
        flex-shrink: 0;
        gap: 12px;
      }
      .tut-nav-btns {
        display: flex;
        gap: 8px;
      }
      .tut-btn {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        padding: 9px 20px;
        border-radius: 9px;
        cursor: pointer;
        font-size: 13px;
        font-family: "DM Sans", sans-serif;
        font-weight: 600;
        transition: all 0.15s;
        border: none;
      }
      .tut-btn-ghost {
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text2);
      }
      .tut-btn-ghost:hover {
        border-color: var(--border2);
        color: var(--text);
      }
      .tut-btn-primary {
        background: var(--teal);
        color: #000;
      }
      .tut-btn-primary:hover {
        filter: brightness(1.08);
      }
      .tut-btn-skip {
        font-size: 12px;
        color: var(--muted);
        cursor: pointer;
        font-family: "JetBrains Mono", monospace;
        transition: color 0.15s;
      }
      .tut-btn-skip:hover {
        color: var(--text);
      }
      /* Mini chapter nav dots */
      .tut-dots {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .tut-dot {
        width: 6px;
        height: 6px;
        border-radius: 3px;
        cursor: pointer;
        background: var(--faint);
        transition: all 0.25s;
      }
      .tut-dot.on {
        width: 18px;
        background: var(--teal);
      }
      /* Tutorial trigger button on rail */
      .rail-tut {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        color: var(--teal);
        background: var(--teal-dim);
        border: 1px solid rgba(6, 214, 160, 0.25);
        transition: all 0.15s;
        position: relative;
      }
      .rail-tut:hover {
        background: rgba(6, 214, 160, 0.2);
        box-shadow: 0 0 12px var(--teal-glow);
      }
      /* Highlight pulse on first load */
      @keyframes tutPulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(6, 214, 160, 0);
        }
        50% {
          box-shadow: 0 0 0 6px rgba(6, 214, 160, 0.25);
        }
      }
      .tut-pulse {
        animation: tutPulse 2s ease 1s 3;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback, useRef } = React;
      const RL = window.Recharts;
      const {
        LineChart,
        Line,
        BarChart,
        Bar,
        AreaChart,
        Area,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        Legend,
        ResponsiveContainer,
        PieChart,
        Pie,
        Cell,
        ReferenceLine,
      } = RL;

      // ═══════════════════════════════════════════════════════════════
      // PALETTE & CONSTANTS
      // ═══════════════════════════════════════════════════════════════
      const P = [
        "#06d6a0",
        "#ffd166",
        "#ef476f",
        "#38bdf8",
        "#a78bfa",
        "#fb923c",
        "#34d399",
        "#f472b6",
        "#60a5fa",
        "#fbbf24",
        "#4ade80",
        "#e879f9",
        "#22d3ee",
        "#f87171",
        "#a3e635",
        "#c084fc",
        "#2dd4bf",
        "#fb7185",
        "#818cf8",
        "#facc15",
        "#6ee7b7",
        "#93c5fd",
        "#d8b4fe",
        "#fdba74",
        "#67e8f9",
        "#bef264",
        "#f9a8d4",
        "#a5b4fc",
        "#fca5a5",
        "#fcd34d",
      ];

      const WAREHOUSES = [
        { key: "annaramWarehouse", label: "Annaram", short: "ANN" },
        { key: "kothurWarehouse", label: "Kothur", short: "KOT" },
        { key: "narkudaWarehouse", label: "Narkhuda", short: "NRK" },
        { key: "p2Warehouse", label: "P2", short: "P2" },
        { key: "p4Warehouse", label: "P4", short: "P4" },
        { key: "p5Warehouse", label: "P5", short: "P5" },
        { key: "p6Warehouse", label: "P6", short: "P6" },
        { key: "primePackWarehouse", label: "Prime Pack", short: "PPK" },
      ];

      const fmt = (n) => (n ?? 0).toLocaleString("en-IN");
      const pct = (v, t) => (t ? ((v / t) * 100).toFixed(1) + "%" : "—");
      const pctn = (v, t) => (t ? +((v / t) * 100).toFixed(1) : 0);

      // ═══════════════════════════════════════════════════════════════
      // DATA
      // ═══════════════════════════════════════════════════════════════
      const BASE_ROWS = [
        {
          slNo: 1,
          customerName: "AMARARAJA",
          wp: 550,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 73731,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 73731,
        },
        {
          slNo: 2,
          customerName: "AMPIN",
          wp: 580,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 1302,
          p2Warehouse: 0,
          p4Warehouse: 14539,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 15841,
        },
        {
          slNo: 3,
          customerName: "BAIDYANATH G12R",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 43970,
          primePackWarehouse: 0,
          grandTotal: 43970,
        },
        {
          slNo: 4,
          customerName: "BLUPINE G12R",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 1268,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 1268,
        },
        {
          slNo: 5,
          customerName: "BRIGHT NIGHT",
          wp: 585,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 2232,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 2232,
        },
        {
          slNo: 6,
          customerName: "CHANNEL SALES",
          wp: 585,
          annaramWarehouse: 0,
          kothurWarehouse: 1054,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 2139,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 3193,
        },
        {
          slNo: 7,
          customerName: "CHANNEL SALES (BLUEPINE DIVERTED)",
          wp: 600,
          annaramWarehouse: 1209,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 1209,
        },
        {
          slNo: 8,
          customerName: "CHANNEL SALES (BLUEPINE DIVERTED)",
          wp: 605,
          annaramWarehouse: 17354,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 17354,
        },
        {
          slNo: 9,
          customerName: "CHANNEL SALES (O2 POWER DIVERTED)",
          wp: 580,
          annaramWarehouse: 6097,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 6097,
        },
        {
          slNo: 10,
          customerName: "CHANNEL SALES DCR (G/T)",
          wp: 540,
          annaramWarehouse: 0,
          kothurWarehouse: 1099,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 1099,
        },
        {
          slNo: 11,
          customerName: "CHANNEL SALES G12R",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 12932,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 1572,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 14504,
        },
        {
          slNo: 12,
          customerName: "CHANNEL SALES G12R DCR(K)",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 7272,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 7272,
        },
        {
          slNo: 13,
          customerName: "CHANNEL SALES NDCR DIVERTED GK",
          wp: 545,
          annaramWarehouse: 0,
          kothurWarehouse: 1767,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 1767,
        },
        {
          slNo: 14,
          customerName: "CONTINNUM",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 20553,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 1333,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 21886,
        },
        {
          slNo: 15,
          customerName: "GK ENERGY DCR (G/T)",
          wp: 535,
          annaramWarehouse: 0,
          kothurWarehouse: 1297,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 1297,
        },
        {
          slNo: 16,
          customerName: "HEXA",
          wp: 585,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 3131,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 3131,
        },
        {
          slNo: 17,
          customerName: "HFE",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 19710,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 19710,
        },
        {
          slNo: 18,
          customerName: "KUSUM",
          wp: 600,
          annaramWarehouse: 0,
          kothurWarehouse: 12245,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 12245,
        },
        {
          slNo: 19,
          customerName: "KUSUM",
          wp: 605,
          annaramWarehouse: 0,
          kothurWarehouse: 28086,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 28086,
        },
        {
          slNo: 20,
          customerName: "KUSUM",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 8822,
          narkudaWarehouse: 4588,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 10575,
          primePackWarehouse: 0,
          grandTotal: 23985,
        },
        {
          slNo: 21,
          customerName: "KUSUM MH-FEB DIVERTED TO SMG",
          wp: 610,
          annaramWarehouse: 0,
          kothurWarehouse: 10354,
          narkudaWarehouse: 0,
          p2Warehouse: 2077,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 12431,
        },
        {
          slNo: 22,
          customerName: "MEIL",
          wp: 585,
          annaramWarehouse: 0,
          kothurWarehouse: 17206,
          narkudaWarehouse: 53629,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 70835,
        },
        {
          slNo: 23,
          customerName: "PANASONIC DCR (G/T)",
          wp: 540,
          annaramWarehouse: 0,
          kothurWarehouse: 1240,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 1240,
        },
        {
          slNo: 24,
          customerName: "PREMIER R",
          wp: 580,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 1023,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 1023,
        },
        {
          slNo: 25,
          customerName: "PREMIER R",
          wp: 585,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 2108,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 2108,
        },
        {
          slNo: 26,
          customerName: "PURELIGHT",
          wp: 580,
          annaramWarehouse: 0,
          kothurWarehouse: 27822,
          narkudaWarehouse: 17887,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 45709,
        },
        {
          slNo: 27,
          customerName: "SHAKTI",
          wp: 535,
          annaramWarehouse: 0,
          kothurWarehouse: 4464,
          narkudaWarehouse: 4247,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 372,
          grandTotal: 9083,
        },
        {
          slNo: 28,
          customerName: "SHAKTI G/T (MH-NOV)",
          wp: 535,
          annaramWarehouse: 0,
          kothurWarehouse: 30504,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 30504,
        },
        {
          slNo: 29,
          customerName: "SHAKTI G/T (MH-JAN) DIVERTED GK",
          wp: 535,
          annaramWarehouse: 0,
          kothurWarehouse: 4712,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 4712,
        },
        {
          slNo: 30,
          customerName: "SMG REALITIES DCR",
          wp: 545,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 2945,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 2945,
        },
        {
          slNo: 31,
          customerName: "SMG REALITIES DCR (G/T)",
          wp: 545,
          annaramWarehouse: 0,
          kothurWarehouse: 10757,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 10757,
        },
        {
          slNo: 32,
          customerName: "SOLAR SQUARE DCR(G/T)",
          wp: 540,
          annaramWarehouse: 0,
          kothurWarehouse: 10292,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 10292,
        },
        {
          slNo: 33,
          customerName: "SOLIDUS",
          wp: 585,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 2635,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 2635,
        },
        {
          slNo: 34,
          customerName: "SUNSURE",
          wp: 585,
          annaramWarehouse: 0,
          kothurWarehouse: 0,
          narkudaWarehouse: 14167,
          p2Warehouse: 0,
          p4Warehouse: 8122,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 22289,
        },
        {
          slNo: 35,
          customerName: "CHANNEL SALES (DIVERTED STOCK)",
          wp: 580,
          annaramWarehouse: 29218,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 29218,
        },
        {
          slNo: 36,
          customerName: "CHANNEL SALES (DIVERTED STOCK)",
          wp: 585,
          annaramWarehouse: 17665,
          kothurWarehouse: 0,
          narkudaWarehouse: 0,
          p2Warehouse: 0,
          p4Warehouse: 0,
          p5Warehouse: 0,
          p6Warehouse: 0,
          primePackWarehouse: 0,
          grandTotal: 17665,
        },
      ];

      // ═══════════════════════════════════════════════════════════════
      // API DATA LAYER — fetches live data from /api/reports
      // Falls back to BASE_ROWS demo data only if API is unreachable
      // ═══════════════════════════════════════════════════════════════
      const API_BASE = window.location.origin + "/api";
      const POLL_INTERVAL_MS = 60 * 1000; // re-check for new reports every 60s

      // Fetch the metadata list + full rows for every report
      async function fetchAllReports() {
        // 1. Get report list (no rows)
        const listRes = await fetch(`${API_BASE}/reports`);
        if (!listRes.ok)
          throw new Error(`API ${listRes.status}: ${listRes.statusText}`);
        const listJson = await listRes.json();
        if (!listJson.success) throw new Error(listJson.error || "API error");

        const meta = listJson.data; // sorted desc by date from API
        if (!meta.length) return [];

        // 2. Fetch full rows for each report in parallel (max 12 at once)
        const full = await Promise.all(
          meta.map((r) =>
            fetch(`${API_BASE}/reports/${r._id}`)
              .then((res) => res.json())
              .then((j) => j.data)
          )
        );

        // 3. Sort ascending by reportDate so charts read left→right
        return full
          .filter(Boolean)
          .sort((a, b) => new Date(a.reportDate) - new Date(b.reportDate));
      }

      // Build synthetic fallback from BASE_ROWS (only used when DB is empty / unreachable)
      function makeFallbackReports() {
        const dates = [
          "14.02.2026",
          "16.02.2026",
          "18.02.2026",
          "19.02.2026",
          "20.02.2026",
          "21.02.2026",
          "22.02.2026",
          "23.02.2026",
        ];
        const noise = () => 0.82 + Math.random() * 0.38;
        return dates.map((d, i) => {
          const f =
            0.6 + (i / dates.length) * 0.45 + (Math.random() * 0.08 - 0.04);
          const rows = BASE_ROWS.map((r) => {
            const rf = f * noise();
            return {
              ...r,
              annaramWarehouse: Math.round(r.annaramWarehouse * rf),
              kothurWarehouse: Math.round(r.kothurWarehouse * rf),
              narkudaWarehouse: Math.round(r.narkudaWarehouse * rf),
              p2Warehouse: Math.round(r.p2Warehouse * rf),
              p4Warehouse: Math.round(r.p4Warehouse * rf),
              p5Warehouse: Math.round(r.p5Warehouse * rf),
              p6Warehouse: Math.round(r.p6Warehouse * rf),
              primePackWarehouse: Math.round(r.primePackWarehouse * rf),
              grandTotal: Math.round(r.grandTotal * rf),
            };
          });
          const gt = (key) => rows.reduce((s, r) => s + (r[key] || 0), 0);
          const overall = rows.reduce((s, r) => s + r.grandTotal, 0);
          return {
            _id: `demo_${d.replace(/\./g, "")}`,
            reportDateStr: d,
            reportDate: d.split(".").reverse().join("-") + "T00:00:00Z",
            grandTotals: {
              annaramWarehouse: gt("annaramWarehouse"),
              kothurWarehouse: gt("kothurWarehouse"),
              narkudaWarehouse: gt("narkudaWarehouse"),
              p2Warehouse: gt("p2Warehouse"),
              p4Warehouse: gt("p4Warehouse"),
              p5Warehouse: gt("p5Warehouse"),
              p6Warehouse: gt("p6Warehouse"),
              primePackWarehouse: gt("primePackWarehouse"),
              overall,
            },
            rows,
          };
        });
      }

      // ── useReports hook — live data + polling ─────────────────────────────────
      function useReports() {
        const [reports, setReports] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [isFallback, setFallback] = useState(false);
        const [lastFetch, setLastFetch] = useState(null);
        const prevCount = useRef(0);
        const [newBadge, setNewBadge] = useState(false); // flashes when new report arrives

        const load = useCallback(async (silent = false) => {
          if (!silent) setLoading(true);
          setError(null);
          try {
            const data = await fetchAllReports();
            if (data.length > 0) {
              setReports(data);
              setFallback(false);
              if (prevCount.current > 0 && data.length > prevCount.current) {
                setNewBadge(true);
                setTimeout(() => setNewBadge(false), 5000);
              }
              prevCount.current = data.length;
            } else {
              // DB empty — show demo data with a notice
              setReports(makeFallbackReports());
              setFallback(true);
            }
          } catch (err) {
            // API unreachable — show demo data with error notice
            if (!silent) {
              setReports(makeFallbackReports());
              setFallback(true);
              setError(err.message);
            }
          } finally {
            setLoading(false);
            setLastFetch(new Date());
          }
        }, []);

        // Initial load
        useEffect(() => {
          load();
        }, [load]);

        // Silent background polling for new reports
        useEffect(() => {
          const id = setInterval(() => load(true), POLL_INTERVAL_MS);
          return () => clearInterval(id);
        }, [load]);

        return {
          reports,
          loading,
          error,
          isFallback,
          newBadge,
          lastFetch,
          reload: load,
        };
      }

      // ═══════════════════════════════════════════════════════════════
      // SHARED COMPONENTS
      // ═══════════════════════════════════════════════════════════════
      function TT({ active, payload, label }) {
        if (!active || !payload?.length) return null;
        return (
          <div className="tt">
            <div className="tt-lbl">{label}</div>
            {payload.map((p, i) => (
              <div key={i} className="tt-row">
                <span className="tt-dot" style={{ background: p.color }} />
                <span className="tt-nm">{p.name}</span>
                <span className="tt-val">{fmt(p.value)}</span>
              </div>
            ))}
          </div>
        );
      }

      function MiniBar({ value, max, color }) {
        const w = max > 0 ? Math.max(2, (value / max) * 80) : 0;
        return (
          <div className="mini-bar">
            <div className="mini-bar-track" style={{ width: 80 }}>
              <div
                className="mini-bar-fill"
                style={{ width: w, background: color + "88" }}
              />
            </div>
            <span
              className="mini-bar-val"
              style={{ color: value > 0 ? color : "var(--faint)" }}
            >
              {value > 0 ? fmt(value) : "—"}
            </span>
          </div>
        );
      }

      function ConfBar({ value }) {
        const color =
          value > 0.7
            ? "var(--teal)"
            : value > 0.4
            ? "var(--amber)"
            : "var(--coral)";
        return (
          <div className="conf-bar">
            <div className="conf-track">
              <div
                className="conf-fill"
                style={{
                  width: `${Math.round(value * 100)}%`,
                  background: color,
                }}
              />
            </div>
            <span className="conf-pct">{Math.round(value * 100)}%</span>
          </div>
        );
      }

      function dlCSV(rows, fn) {
        const H = [
          "Sl No",
          "Customer",
          "WP",
          "Annaram",
          "Kothur",
          "Narkhuda",
          "P2",
          "P4",
          "P5",
          "P6",
          "Prime Pack",
          "Total",
        ];
        const lines = rows.map((r) =>
          [
            r.slNo,
            `"${r.customerName}"`,
            r.wp,
            r.annaramWarehouse,
            r.kothurWarehouse,
            r.narkudaWarehouse,
            r.p2Warehouse,
            r.p4Warehouse,
            r.p5Warehouse,
            r.p6Warehouse,
            r.primePackWarehouse,
            r.grandTotal,
          ].join(",")
        );
        const b = new Blob([[H.join(","), ...lines].join("\n")], {
          type: "text/csv",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = fn;
        a.click();
      }
      function dlJSON(d, fn) {
        const b = new Blob([JSON.stringify(d, null, 2)], {
          type: "application/json",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = fn;
        a.click();
      }

      // ═══════════════════════════════════════════════════════════════
      // COUNT-UP ANIMATION HOOK
      // ═══════════════════════════════════════════════════════════════
      function useCountUp(target, duration = 900) {
        const [val, setVal] = useState(0);
        const prev = useRef(0);
        useEffect(() => {
          const start = prev.current;
          const diff = target - start;
          if (diff === 0) return;
          const startTime = performance.now();
          let raf;
          const step = (now) => {
            const t = Math.min(1, (now - startTime) / duration);
            const ease = 1 - Math.pow(1 - t, 3);
            setVal(Math.round(start + diff * ease));
            if (t < 1) raf = requestAnimationFrame(step);
            else prev.current = target;
          };
          raf = requestAnimationFrame(step);
          return () => cancelAnimationFrame(raf);
        }, [target, duration]);
        return val;
      }

      // ═══════════════════════════════════════════════════════════════
      // DRILLDOWN: WAREHOUSE DETAIL
      // ═══════════════════════════════════════════════════════════════
      function WarehouseDetail({
        wh,
        reports,
        report,
        onBack,
        onCustomerDrill,
      }) {
        const whLabel = wh.label;
        const whKey = wh.key;
        const whColor = P[WAREHOUSES.findIndex((w) => w.key === whKey)];
        const trend = reports.map((r) => ({
          date: r.reportDateStr,
          value: r.grandTotals?.[whKey] || 0,
        }));
        const latest = trend[trend.length - 1]?.value || 0;
        const prev = trend[trend.length - 2]?.value || 0;
        const delta = latest - prev;
        const custRows = report.rows
          .filter((r) => (r[whKey] || 0) > 0)
          .sort((a, b) => b[whKey] - a[whKey]);
        const maxVal = custRows[0]?.[whKey] || 1;
        const animated = useCountUp(latest);

        return (
          <div className="fade-up">
            <div className="drill-header">
              <div>
                <div className="drill-title" style={{ color: whColor }}>
                  {whLabel} Warehouse
                </div>
                <div className="drill-meta">
                  {custRows.length} active customers · {report.reportDateStr}
                </div>
              </div>
              <button className="btn-back" onClick={onBack}>
                ← Back
              </button>
            </div>
            <div className="stat-grid">
              {[
                { label: "Total Stock", val: fmt(animated) },
                {
                  label: "Period Delta",
                  val: `${delta >= 0 ? "+" : ""}${fmt(delta)}`,
                  sub:
                    prev > 0
                      ? `${((delta / prev) * 100).toFixed(1)}% vs prev`
                      : "",
                },
                { label: "Active Customers", val: custRows.length },
                {
                  label: "Share of Portfolio",
                  val: pct(latest, report.grandTotals?.overall || 1),
                },
              ].map((s, i) => (
                <div
                  key={i}
                  className="stat-box fade-up"
                  style={{ animationDelay: `${i * 0.06}s` }}
                >
                  <div className="stat-label">{s.label}</div>
                  <div className="stat-value" style={{ color: whColor }}>
                    {s.val}
                  </div>
                  {s.sub && <div className="stat-sub">{s.sub}</div>}
                </div>
              ))}
            </div>
            <div className="two-col" style={{ marginBottom: 16 }}>
              <div className="panel">
                <div className="panel-head">
                  <span className="panel-title">
                    <span
                      className="panel-title-dot"
                      style={{ background: whColor }}
                    />
                    {whLabel} — Stock Trend
                  </span>
                </div>
                <div className="panel-body">
                  <ResponsiveContainer width="100%" height={160}>
                    <AreaChart data={trend}>
                      <defs>
                        <linearGradient id="whdg" x1="0" y1="0" x2="0" y2="1">
                          <stop
                            offset="5%"
                            stopColor={whColor}
                            stopOpacity={0.3}
                          />
                          <stop
                            offset="95%"
                            stopColor={whColor}
                            stopOpacity={0}
                          />
                        </linearGradient>
                      </defs>
                      <CartesianGrid
                        strokeDasharray="3 3"
                        stroke="var(--border)"
                        vertical={false}
                      />
                      <XAxis
                        dataKey="date"
                        tick={{
                          fill: "var(--muted)",
                          fontSize: 9,
                          fontFamily: "JetBrains Mono",
                        }}
                        axisLine={false}
                        tickLine={false}
                      />
                      <YAxis hide />
                      <Tooltip content={<TT />} />
                      <Area
                        type="monotone"
                        dataKey="value"
                        name={whLabel}
                        stroke={whColor}
                        strokeWidth={2}
                        fill="url(#whdg)"
                        dot={false}
                      />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </div>
              <div className="panel">
                <div className="panel-head">
                  <span className="panel-title">
                    Top Customers in {whLabel}
                  </span>
                </div>
                <div className="panel-body">
                  <ResponsiveContainer width="100%" height={160}>
                    <BarChart
                      data={custRows
                        .slice(0, 8)
                        .map((r) => ({
                          name:
                            r.customerName.length > 14
                              ? r.customerName.slice(0, 14) + "…"
                              : r.customerName,
                          value: r[whKey] || 0,
                        }))}
                    >
                      <CartesianGrid
                        strokeDasharray="3 3"
                        stroke="var(--border)"
                        horizontal={false}
                      />
                      <XAxis
                        dataKey="name"
                        tick={{
                          fill: "var(--muted)",
                          fontSize: 8,
                          fontFamily: "JetBrains Mono",
                        }}
                        axisLine={false}
                        tickLine={false}
                      />
                      <YAxis hide />
                      <Tooltip content={<TT />} />
                      <Bar
                        dataKey="value"
                        name="Units"
                        fill={whColor}
                        radius={[4, 4, 0, 0]}
                        onClick={(d) => {
                          const row = report.rows.find((r) =>
                            r.customerName.startsWith(
                              d.name.replace("…", "").trim()
                            )
                          );
                          if (row && onCustomerDrill) onCustomerDrill(row);
                        }}
                        style={{ cursor: "pointer" }}
                      />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
            <div className="panel">
              <div className="panel-head">
                <span className="panel-title">All Customers in {whLabel}</span>
              </div>
              <div className="tbl-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style={{ textAlign: "left" }}>Rank</th>
                      <th style={{ textAlign: "left" }}>Customer</th>
                      <th style={{ textAlign: "left" }}>WP</th>
                      <th>Units</th>
                      <th>Share</th>
                    </tr>
                  </thead>
                  <tbody>
                    {custRows.map((row, i) => (
                      <tr
                        key={i}
                        className="clickable"
                        onClick={() => onCustomerDrill && onCustomerDrill(row)}
                      >
                        <td
                          style={{ fontFamily: "JetBrains Mono", fontSize: 10 }}
                        >
                          #{i + 1}
                        </td>
                        <td
                          style={{
                            textAlign: "left",
                            color: "var(--text)",
                            fontWeight: 600,
                          }}
                        >
                          {row.customerName}
                        </td>
                        <td
                          style={{
                            textAlign: "left",
                            fontFamily: "JetBrains Mono",
                            fontSize: 11,
                          }}
                        >
                          {row.wp}
                        </td>
                        <td>
                          <MiniBar
                            value={row[whKey] || 0}
                            max={maxVal}
                            color={whColor}
                          />
                        </td>
                        <td
                          style={{
                            fontFamily: "JetBrains Mono",
                            fontSize: 11,
                            color: "var(--muted)",
                          }}
                        >
                          {pct(row[whKey] || 0, latest)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      }

      // ═══════════════════════════════════════════════════════════════
      // DRILLDOWN: CUSTOMER DETAIL
      // ═══════════════════════════════════════════════════════════════
      function CustomerDetail({
        customer,
        reports,
        report,
        onBack,
        onWhDrill,
      }) {
        const name = customer.customerName;
        const wp = customer.wp;
        const color = P[customer.slNo % P.length];

        const custData = reports.map((rep) => {
          const row = rep.rows.find(
            (r) => r.customerName === name && r.wp === wp
          );
          const obj = { date: rep.reportDateStr, Total: row?.grandTotal || 0 };
          WAREHOUSES.forEach((w) => {
            obj[w.label] = row?.[w.key] || 0;
          });
          return obj;
        });

        const latest =
          report.rows.find((r) => r.customerName === name && r.wp === wp) || {};
        const latestTotal = latest.grandTotal || 0;
        const prevRow = reports[reports.length - 2]?.rows.find(
          (r) => r.customerName === name && r.wp === wp
        );
        const prevTotal = prevRow?.grandTotal || 0;
        const delta = latestTotal - prevTotal;
        const activeWarehouses = WAREHOUSES.filter(
          (w) => (latest[w.key] || 0) > 0
        );
        const animated = useCountUp(latestTotal);

        return (
          <div className="fade-up">
            <div className="drill-header">
              <div>
                <div className="drill-title" style={{ color }}>
                  {name}
                </div>
                <div className="drill-meta">
                  WP {wp} · {activeWarehouses.length} warehouse
                  {activeWarehouses.length !== 1 ? "s" : ""} ·{" "}
                  {report.reportDateStr}
                </div>
              </div>
              <button className="btn-back" onClick={onBack}>
                ← Back
              </button>
            </div>
            <div className="stat-grid">
              {[
                { label: "Total Stock", val: fmt(animated) },
                {
                  label: "Period Change",
                  val: `${delta >= 0 ? "+" : ""}${fmt(delta)}`,
                  sub:
                    prevTotal > 0
                      ? `${((delta / prevTotal) * 100).toFixed(1)}%`
                      : "",
                },
                { label: "Warehouses", val: activeWarehouses.length },
                { label: "WP", val: wp },
              ].map((s, i) => (
                <div
                  key={i}
                  className="stat-box fade-up"
                  style={{ animationDelay: `${i * 0.06}s` }}
                >
                  <div className="stat-label">{s.label}</div>
                  <div className="stat-value" style={{ color }}>
                    {s.val}
                  </div>
                  {s.sub && <div className="stat-sub">{s.sub}</div>}
                </div>
              ))}
            </div>
            <div className="two-col" style={{ marginBottom: 16 }}>
              <div className="panel">
                <div className="panel-head">
                  <span className="panel-title">
                    <span
                      className="panel-title-dot"
                      style={{ background: color }}
                    />
                    {name} — Total Stock Trend
                  </span>
                </div>
                <div className="panel-body">
                  <ResponsiveContainer width="100%" height={160}>
                    <AreaChart data={custData}>
                      <defs>
                        <linearGradient id="cdg" x1="0" y1="0" x2="0" y2="1">
                          <stop
                            offset="5%"
                            stopColor={color}
                            stopOpacity={0.3}
                          />
                          <stop
                            offset="95%"
                            stopColor={color}
                            stopOpacity={0}
                          />
                        </linearGradient>
                      </defs>
                      <CartesianGrid
                        strokeDasharray="3 3"
                        stroke="var(--border)"
                        vertical={false}
                      />
                      <XAxis
                        dataKey="date"
                        tick={{
                          fill: "var(--muted)",
                          fontSize: 9,
                          fontFamily: "JetBrains Mono",
                        }}
                        axisLine={false}
                        tickLine={false}
                      />
                      <YAxis hide />
                      <Tooltip content={<TT />} />
                      <Area
                        type="monotone"
                        dataKey="Total"
                        stroke={color}
                        strokeWidth={2}
                        fill="url(#cdg)"
                        dot={false}
                      />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </div>
              <div className="panel">
                <div className="panel-head">
                  <span className="panel-title">Warehouse Breakdown</span>
                </div>
                <div className="panel-body">
                  <ResponsiveContainer width="100%" height={160}>
                    <BarChart
                      data={activeWarehouses.map((w, i) => ({
                        name: w.label,
                        value: latest[w.key] || 0,
                        fill: P[i],
                      }))}
                    >
                      <CartesianGrid
                        strokeDasharray="3 3"
                        stroke="var(--border)"
                        horizontal={false}
                      />
                      <XAxis
                        dataKey="name"
                        tick={{
                          fill: "var(--muted)",
                          fontSize: 9,
                          fontFamily: "JetBrains Mono",
                        }}
                        axisLine={false}
                        tickLine={false}
                      />
                      <YAxis hide />
                      <Tooltip content={<TT />} />
                      <Bar
                        dataKey="value"
                        name="Units"
                        radius={[4, 4, 0, 0]}
                        onClick={(d) => {
                          const wh = WAREHOUSES.find((w) => w.label === d.name);
                          if (wh && onWhDrill) onWhDrill(wh);
                        }}
                        style={{ cursor: "pointer" }}
                      >
                        {activeWarehouses.map((_, i) => (
                          <Cell key={i} fill={P[i]} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
            <div className="panel">
              <div className="panel-head">
                <span className="panel-title">
                  Warehouse Distribution over Time
                </span>
              </div>
              <div className="panel-body">
                <ResponsiveContainer width="100%" height={180}>
                  <AreaChart data={custData}>
                    <CartesianGrid
                      strokeDasharray="3 3"
                      stroke="var(--border)"
                      vertical={false}
                    />
                    <XAxis
                      dataKey="date"
                      tick={{
                        fill: "var(--muted)",
                        fontSize: 9,
                        fontFamily: "JetBrains Mono",
                      }}
                      axisLine={false}
                      tickLine={false}
                    />
                    <YAxis hide />
                    <Tooltip content={<TT />} />
                    <Legend
                      wrapperStyle={{
                        fontSize: 11,
                        fontFamily: "JetBrains Mono",
                      }}
                    />
                    {WAREHOUSES.map((w, i) => (
                      <Area
                        key={w.key}
                        type="monotone"
                        dataKey={w.label}
                        stackId="1"
                        stroke={P[i]}
                        fill={P[i] + "55"}
                        dot={false}
                        strokeWidth={1.5}
                      />
                    ))}
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </div>
            <div className="panel" style={{ marginTop: 16 }}>
              <div className="panel-head">
                <span className="panel-title">
                  Warehouse Detail (click to drill further)
                </span>
              </div>
              <div className="tbl-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style={{ textAlign: "left" }}>Warehouse</th>
                      <th>Units</th>
                      <th>Share</th>
                      <th>All Periods</th>
                    </tr>
                  </thead>
                  <tbody>
                    {WAREHOUSES.map((w, i) => {
                      const v = latest[w.key] || 0;
                      if (!v && !custData.some((d) => d[w.label] > 0))
                        return null;
                      return (
                        <tr
                          key={w.key}
                          className="clickable"
                          onClick={() => onWhDrill && onWhDrill(w)}
                        >
                          <td style={{ textAlign: "left" }}>
                            <span
                              style={{
                                display: "flex",
                                alignItems: "center",
                                gap: 8,
                              }}
                            >
                              <span
                                style={{
                                  width: 8,
                                  height: 8,
                                  background: P[i],
                                  borderRadius: 2,
                                  display: "inline-block",
                                }}
                              />
                              <span
                                style={{
                                  color: "var(--text)",
                                  fontWeight: 600,
                                }}
                              >
                                {w.label}
                              </span>
                            </span>
                          </td>
                          <td>
                            <MiniBar
                              value={v}
                              max={latestTotal || 1}
                              color={P[i]}
                            />
                          </td>
                          <td
                            style={{
                              fontFamily: "JetBrains Mono",
                              fontSize: 11,
                              color: "var(--muted)",
                            }}
                          >
                            {pct(v, latestTotal || 1)}
                          </td>
                          <td>
                            <div
                              style={{
                                display: "flex",
                                gap: 2,
                                alignItems: "flex-end",
                                height: 22,
                                justifyContent: "flex-end",
                              }}
                            >
                              {custData.map((d, j) => {
                                const mx = Math.max(
                                  ...custData.map((x) => x[w.label] || 0),
                                  1
                                );
                                const h = Math.max(
                                  2,
                                  Math.round(((d[w.label] || 0) / mx) * 22)
                                );
                                return (
                                  <div
                                    key={j}
                                    style={{
                                      width: 6,
                                      height: h,
                                      background: P[i],
                                      borderRadius: 2,
                                      opacity: 0.7,
                                    }}
                                  />
                                );
                              })}
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      }

      // ═══════════════════════════════════════════════════════════════
      // DRILLDOWN: CUSTOMER × WAREHOUSE
      // ═══════════════════════════════════════════════════════════════
      function CxWDetail({
        customer,
        wh,
        reports,
        report,
        onBack,
        onBackToCustomer,
      }) {
        const name = customer.customerName;
        const wp = customer.wp;
        const whKey = wh.key;
        const whColor = P[WAREHOUSES.findIndex((w) => w.key === whKey)];
        const custColor = P[customer.slNo % P.length];

        const ts = reports.map((r) => {
          const row = r.rows.find(
            (x) => x.customerName === name && x.wp === wp
          );
          return {
            date: r.reportDateStr,
            value: row?.[whKey] || 0,
            total: row?.grandTotal || 0,
          };
        });

        const latest = ts[ts.length - 1]?.value || 0;
        const prev = ts[ts.length - 2]?.value || 0;
        const delta = latest - prev;
        const animated = useCountUp(latest);

        return (
          <div className="fade-up">
            <div className="drill-header">
              <div>
                <div className="drill-title" style={{ color: whColor }}>
                  {wh.label} · <span style={{ color: custColor }}>{name}</span>
                </div>
                <div className="drill-meta">
                  WP {wp} · Cross-drill view · {report.reportDateStr}
                </div>
              </div>
              <div style={{ display: "flex", gap: 8 }}>
                <button className="btn-back" onClick={onBackToCustomer}>
                  ← {name}
                </button>
                <button className="btn-back" onClick={onBack}>
                  ← Overview
                </button>
              </div>
            </div>
            <div className="stat-grid">
              {[
                {
                  label: "In This Warehouse",
                  val: fmt(animated),
                  color: whColor,
                },
                {
                  label: "Period Change",
                  val: `${delta >= 0 ? "+" : ""}${fmt(delta)}`,
                  color: delta >= 0 ? "var(--teal)" : "var(--coral)",
                },
                {
                  label: "% of Customer Total",
                  val: pct(
                    latest,
                    report.rows.find(
                      (r) => r.customerName === name && r.wp === wp
                    )?.grandTotal || 1
                  ),
                  color: custColor,
                },
                {
                  label: "% of Warehouse",
                  val: pct(latest, report.grandTotals?.[whKey] || 1),
                  color: whColor,
                },
              ].map((s, i) => (
                <div
                  key={i}
                  className="stat-box fade-up"
                  style={{ animationDelay: `${i * 0.06}s` }}
                >
                  <div className="stat-label">{s.label}</div>
                  <div className="stat-value" style={{ color: s.color }}>
                    {s.val}
                  </div>
                </div>
              ))}
            </div>
            <div className="panel">
              <div className="panel-head">
                <span className="panel-title">
                  <span
                    className="panel-title-dot"
                    style={{ background: whColor }}
                  />
                  {name} in {wh.label} — Historical
                </span>
              </div>
              <div className="panel-body">
                <ResponsiveContainer width="100%" height={200}>
                  <AreaChart data={ts}>
                    <defs>
                      <linearGradient id="cxwdg" x1="0" y1="0" x2="0" y2="1">
                        <stop
                          offset="5%"
                          stopColor={whColor}
                          stopOpacity={0.35}
                        />
                        <stop
                          offset="95%"
                          stopColor={whColor}
                          stopOpacity={0}
                        />
                      </linearGradient>
                    </defs>
                    <CartesianGrid
                      strokeDasharray="3 3"
                      stroke="var(--border)"
                      vertical={false}
                    />
                    <XAxis
                      dataKey="date"
                      tick={{
                        fill: "var(--muted)",
                        fontSize: 9,
                        fontFamily: "JetBrains Mono",
                      }}
                      axisLine={false}
                      tickLine={false}
                    />
                    <YAxis hide />
                    <Tooltip content={<TT />} />
                    <Area
                      type="monotone"
                      dataKey="value"
                      name={`${name} @ ${wh.label}`}
                      stroke={whColor}
                      strokeWidth={2.5}
                      fill="url(#cxwdg)"
                      dot={{ fill: whColor, r: 4, strokeWidth: 0 }}
                    />
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>
        );
      }

      // ═══════════════════════════════════════════════════════════════
      // INTELLIGENCE ENGINE
      // ═══════════════════════════════════════════════════════════════
      function linReg(ys) {
        const n = ys.length;
        if (n < 2) return { slope: 0, r2: 0, direction: "stable", mean: 0 };
        const xs = ys.map((_, i) => i);
        const mx = xs.reduce((a, b) => a + b, 0) / n,
          my = ys.reduce((a, b) => a + b, 0) / n;
        const ssxy = xs.reduce((s, x, i) => s + (x - mx) * (ys[i] - my), 0);
        const ssxx = xs.reduce((s, x) => s + (x - mx) ** 2, 0);
        const ssyy = ys.reduce((s, y) => s + (y - my) ** 2, 0);
        const slope = ssxx === 0 ? 0 : ssxy / ssxx;
        const r2 = ssyy === 0 ? 0 : ssxy ** 2 / (ssxx * ssyy);
        const direction =
          Math.abs(slope) < my * 0.02
            ? "stable"
            : slope > 0
            ? "rising"
            : "falling";
        return { slope, r2: Math.min(1, Math.max(0, r2)), direction, mean: my };
      }
      function zScore(v) {
        const n = v.length;
        if (n < 3) return v.map(() => 0);
        const m = v.reduce((a, b) => a + b, 0) / n;
        const s = Math.sqrt(v.reduce((x, y) => x + (y - m) ** 2, 0) / n) || 1;
        return v.map((x) => (x - m) / s);
      }
      function hhi(v) {
        const t = v.reduce((a, b) => a + b, 0);
        if (!t) return 0;
        return v.reduce((s, x) => s + (x / t) ** 2, 0);
      }
      function momentum(ys) {
        if (ys.length < 3) return 0;
        const r = ys.slice(-2);
        const o = ys.slice(0, -2);
        const rd = r[1] - r[0];
        const od = o.length < 2 ? 0 : (o[o.length - 1] - o[0]) / (o.length - 1);
        return Math.max(-3, Math.min(3, (rd - od) / Math.max(Math.abs(od), 1)));
      }
      function volatility(ys) {
        const n = ys.length;
        if (n < 2) return 0;
        const m = ys.reduce((a, b) => a + b, 0) / n;
        if (!m) return 0;
        return Math.min(
          1,
          Math.sqrt(ys.reduce((s, v) => s + (v - m) ** 2, 0) / n) / m
        );
      }
      function project(ys) {
        const { slope } = linReg(ys);
        return Math.max(0, Math.round((ys[ys.length - 1] || 0) + slope));
      }

      function runIntelligence(reports) {
        if (!reports || reports.length < 2)
          return {
            signals: [],
            recommendations: [],
            placement: [],
            retrospective: [],
            summary: "",
            custSignals: [],
            whSignals: [],
            overallHHI: 0,
          };
        const latest = reports[reports.length - 1];
        const signals = [],
          recommendations = [],
          placement = [],
          retrospective = [];
        const seen = new Set();
        const allCK = [];
        latest.rows.forEach((r) => {
          const k = `${r.customerName}||${r.wp}`;
          if (!seen.has(k)) {
            seen.add(k);
            allCK.push({ name: r.customerName, wp: r.wp });
          }
        });
        const custSignals = allCK
          .map((ck) => {
            const ts = reports.map((rep) => {
              const row = rep.rows.find(
                (r) => r.customerName === ck.name && r.wp === ck.wp
              );
              return row?.grandTotal || 0;
            });
            const reg = linReg(ts);
            const mom = momentum(ts);
            const vol = volatility(ts);
            const zs = zScore(ts);
            const latestZ = zs[zs.length - 1] || 0;
            const lv = ts[ts.length - 1] || 0;
            const pv = ts[ts.length - 2] || 0;
            const deltaAbs = lv - pv;
            const deltaPct = pv > 0 ? ((lv - pv) / pv) * 100 : 0;
            const proj = project(ts);
            const latestRow = latest.rows.find(
              (r) => r.customerName === ck.name && r.wp === ck.wp
            );
            const usedWH = WAREHOUSES.filter(
              (w) => latestRow && (latestRow[w.key] || 0) > 0
            );
            const whHHI = latestRow
              ? hhi(WAREHOUSES.map((w) => latestRow[w.key] || 0))
              : 0;
            const whConcentrated =
              whHHI > 0.85 && usedWH.length === 1 && lv > 5000;
            return {
              ...ck,
              ts,
              reg,
              mom,
              vol,
              latestZ,
              latest: lv,
              prev: pv,
              deltaAbs,
              deltaPct,
              proj,
              usedWH,
              whHHI,
              whConcentrated,
            };
          })
          .filter((c) => c.latest > 0 || c.prev > 0);

        const whSignals = WAREHOUSES.map((wh) => {
          const ts = reports.map((r) => r.grandTotals?.[wh.key] || 0);
          const reg = linReg(ts);
          const mom = momentum(ts);
          const vol = volatility(ts);
          const lv = ts[ts.length - 1] || 0;
          const total = latest.grandTotals?.overall || 0;
          const share = total > 0 ? lv / total : 0;
          const proj = project(ts);
          const custCount = latest.rows.filter(
            (r) => (r[wh.key] || 0) > 0
          ).length;
          const custHHI = hhi(latest.rows.map((r) => r[wh.key] || 0));
          return {
            ...wh,
            ts,
            reg,
            mom,
            vol,
            latest: lv,
            share,
            proj,
            custCount,
            custHHI,
          };
        });

        const totalTs = reports.map((r) => r.grandTotals?.overall || 0);
        const totalReg = linReg(totalTs);
        const totalMom = momentum(totalTs);
        const overallHHI = hhi(
          WAREHOUSES.map((w) => latest.grandTotals?.[w.key] || 0)
        );
        const latestTotal = totalTs[totalTs.length - 1] || 0;
        const prevTotal = totalTs[totalTs.length - 2] || 0;
        const totalDelta = latestTotal - prevTotal;
        const totalDeltaPct =
          prevTotal > 0 ? (totalDelta / prevTotal) * 100 : 0;

        signals.push({
          type:
            totalReg.direction === "rising"
              ? "positive"
              : totalReg.direction === "falling"
              ? "negative"
              : "neutral",
          category: "Portfolio",
          title: `Overall stock is ${totalReg.direction}`,
          detail: `${totalDeltaPct >= 0 ? "+" : ""}${totalDeltaPct.toFixed(
            1
          )}% this period (${fmt(
            Math.abs(totalDelta)
          )} units). Confidence: ${Math.round(totalReg.r2 * 100)}%`,
          confidence: totalReg.r2,
          icon:
            totalReg.direction === "rising"
              ? "▲"
              : totalReg.direction === "falling"
              ? "▼"
              : "→",
        });
        if (overallHHI > 0.35) {
          const tw = [...whSignals].sort((a, b) => b.latest - a.latest)[0];
          signals.push({
            type: "warning",
            category: "Concentration",
            title: `High warehouse concentration (HHI ${overallHHI.toFixed(
              2
            )})`,
            detail: `${tw.label} holds ${Math.round(
              tw.share * 100
            )}% of all stock. Single-point dependency risk.`,
            confidence: 0.9,
            icon: "⚠",
          });
        }
        custSignals
          .filter(
            (c) =>
              c.reg.direction === "rising" && c.reg.r2 > 0.6 && c.latest > 2000
          )
          .slice(0, 3)
          .forEach((c) =>
            signals.push({
              type: "positive",
              category: "Growth",
              title: `${c.name} — consistent growth`,
              detail: `+${c.deltaPct.toFixed(1)}% this period. Projected: ${fmt(
                c.proj
              )}. R²=${Math.round(c.reg.r2 * 100)}%`,
              confidence: c.reg.r2,
              icon: "↗",
              customer: c.name,
            })
          );
        custSignals
          .filter(
            (c) =>
              c.reg.direction === "falling" && c.reg.r2 > 0.5 && c.prev > 3000
          )
          .slice(0, 3)
          .forEach((c) =>
            signals.push({
              type: "negative",
              category: "Decline",
              title: `${c.name} — declining trend`,
              detail: `${c.deltaPct.toFixed(1)}% this period. Projected: ${fmt(
                c.proj
              )} next cycle.`,
              confidence: c.reg.r2,
              icon: "↘",
              customer: c.name,
            })
          );
        custSignals
          .filter((c) => Math.abs(c.latestZ) > 1.8 && c.latest > 1000)
          .forEach((c) => {
            const dir = c.latestZ > 0 ? "spike" : "drop";
            signals.push({
              type: c.latestZ > 0 ? "warning" : "negative",
              category: "Anomaly",
              title: `${c.name} — unusual ${dir}`,
              detail: `${Math.abs(c.latestZ).toFixed(1)}σ deviation. ${fmt(
                c.latest
              )} vs avg ${fmt(
                Math.round(c.ts.reduce((a, b) => a + b, 0) / c.ts.length)
              )}`,
              confidence: Math.min(0.95, Math.abs(c.latestZ) / 3),
              icon: c.latestZ > 0 ? "⬆" : "⬇",
              customer: c.name,
            });
          });
        custSignals
          .filter((c) => c.vol > 0.35 && c.latest > 5000)
          .slice(0, 2)
          .forEach((c) =>
            signals.push({
              type: "warning",
              category: "Volatility",
              title: `${c.name} — high volatility`,
              detail: `CV ${Math.round(
                c.vol * 100
              )}% — stock swings significantly each period.`,
              confidence: 0.8,
              icon: "≈",
              customer: c.name,
            })
          );

        const sw = [...whSignals].sort((a, b) => b.latest - a.latest);
        if (sw[0] && sw[0].share > 0.38 && sw[1]) {
          recommendations.push({
            priority: "HIGH",
            type: "Rebalancing",
            title: `Reduce over-concentration in ${sw[0].label}`,
            rationale: `${sw[0].label} holds ${Math.round(
              sw[0].share * 100
            )}% of total stock.`,
            action: `Move 10–15% of ${sw[0].label} stock (~${fmt(
              Math.round(sw[0].latest * 0.12)
            )} units) to underutilised warehouses.`,
            impact: "Risk reduction · Supply chain resilience",
            confidence: 0.82,
          });
        }
        custSignals
          .filter(
            (c) =>
              c.reg.direction === "rising" &&
              c.latest > 10000 &&
              c.reg.r2 > 0.55
          )
          .slice(0, 2)
          .forEach((c) => {
            const tw2 = c.usedWH[0];
            recommendations.push({
              priority: "MEDIUM",
              type: "Pre-positioning",
              title: `Pre-position stock for ${c.name}`,
              rationale: `Consistent ${
                c.deltaPct >= 0 ? "+" : ""
              }${c.deltaPct.toFixed(1)}% growth. Projected ${fmt(
                c.proj
              )} needed next cycle.`,
              action: `Ensure ${fmt(
                Math.max(c.proj, c.latest)
              )} units ready in ${
                tw2 ? tw2.label : "primary warehouse"
              } before next cycle.`,
              impact: "Prevent stockouts · Maintain continuity",
              confidence: c.reg.r2,
            });
          });
        custSignals
          .filter(
            (c) =>
              c.reg.direction === "falling" && c.latest > 8000 && c.reg.r2 > 0.5
          )
          .slice(0, 2)
          .forEach((c) => {
            recommendations.push({
              priority: "HIGH",
              type: "Dispatch Priority",
              title: `Accelerate dispatch for ${c.name}`,
              rationale: `${fmt(
                c.latest
              )} units held while demand trend is declining ${c.deltaPct.toFixed(
                1
              )}% per period.`,
              action: `Escalate dispatch schedule. Consider re-allocation if unresolved in 2 cycles.`,
              impact: "Reduce holding cost · Free capacity",
              confidence: c.reg.r2,
            });
          });
        custSignals
          .filter((c) => c.whConcentrated && c.latest > 5000)
          .slice(0, 3)
          .forEach((c) => {
            const ow = WAREHOUSES.filter(
              (w) => !c.usedWH.find((u) => u.key === w.key)
            ).slice(0, 1);
            recommendations.push({
              priority: "MEDIUM",
              type: "Resilience",
              title: `Split ${c.name} across multiple warehouses`,
              rationale: `100% of ${fmt(c.latest)} units in ${
                c.usedWH[0]?.label
              }. Any disruption halts supply.`,
              action: `Keep 70% in ${c.usedWH[0]?.label}, move 30% (~${fmt(
                Math.round(c.latest * 0.3)
              )}) to ${ow[0]?.label || "secondary"}.`,
              impact: "Reduce single-point-of-failure risk",
              confidence: 0.78,
            });
          });
        const unused = whSignals.filter(
          (w) => w.latest > 0 && w.share < 0.01 && w.custCount <= 1
        );
        if (unused.length > 0)
          recommendations.push({
            priority: "LOW",
            type: "Utilisation",
            title: `Underutilised warehouses detected`,
            rationale: `${unused
              .map((w) => w.label)
              .join(", ")} hold under 1% of total stock.`,
            action: `Review strategic value. If none, consolidate and reallocate capacity budget.`,
            impact: "Operational cost reduction",
            confidence: 0.7,
          });

        custSignals
          .filter((c) => c.latest > 5000 && c.usedWH.length === 1)
          .forEach((c) => {
            const cw = c.usedWH[0];
            if (!cw) return;
            const cl = whSignals.find((w) => w.key === cw.key);
            const bw = [...whSignals]
              .filter((w) => w.key !== cw.key)
              .sort((a, b) => a.share - b.share)[0];
            if (bw && cl && cl.share > 0.25)
              placement.push({
                customer: c.name,
                wp: c.wp,
                currentWH: cw.label,
                currentWHLoad: Math.round(cl.share * 100),
                suggestedWH: bw.label,
                suggestedWHLoad: Math.round(bw.share * 100),
                stockQty: c.latest,
                reason: `${cw.label} carries ${Math.round(
                  cl.share * 100
                )}% of total. Redistributing improves balance.`,
                benefit: "Load balance · Reduced risk",
                confidence: Math.min(0.9, 0.5 + cl.share),
              });
          });

        custSignals
          .filter((c) => c.deltaAbs > 1000 && c.deltaPct > 10)
          .slice(0, 3)
          .forEach((c) =>
            retrospective.push({
              type: "win",
              title: `${c.name} exceeded expectations`,
              detail: `+${fmt(c.deltaAbs)} units (+${c.deltaPct.toFixed(1)}%).`,
              lesson: `Continue current warehouse placement for this customer.`,
            })
          );
        custSignals
          .filter((c) => c.deltaAbs < -1000 && c.deltaPct < -10)
          .slice(0, 3)
          .forEach((c) =>
            retrospective.push({
              type: "miss",
              title: `${c.name} dropped more than expected`,
              detail: `${fmt(
                Math.abs(c.deltaAbs)
              )} units removed (${c.deltaPct.toFixed(1)}%).`,
              lesson: `Investigate — demand slowdown or dispatch completion?`,
            })
          );
        custSignals
          .filter((c) => c.proj > 0 && c.latest < c.proj * 0.8 && c.prev > 2000)
          .slice(0, 2)
          .forEach((c) =>
            retrospective.push({
              type: "opportunity",
              title: `${c.name} — under-supplied vs projection`,
              detail: `Expected ~${fmt(c.proj)} but actual ${fmt(
                c.latest
              )} (gap: ${fmt(c.proj - c.latest)}).`,
              lesson: `Review allocation. Prioritise replenishment next cycle.`,
            })
          );

        const dirWord =
          totalReg.direction === "rising"
            ? "expanding"
            : totalReg.direction === "falling"
            ? "contracting"
            : "stable";
        const riskLevel =
          overallHHI > 0.4
            ? "elevated concentration risk"
            : overallHHI > 0.25
            ? "moderate concentration"
            : "well-distributed";
        const tg = custSignals
          .filter((c) => c.reg.direction === "rising")
          .sort((a, b) => b.reg.r2 - a.reg.r2)[0];
        const td = custSignals
          .filter((c) => c.reg.direction === "falling")
          .sort((a, b) => b.reg.r2 - a.reg.r2)[0];
        const summary = `Portfolio is ${dirWord} with ${
          totalDeltaPct >= 0 ? "+" : ""
        }${totalDeltaPct.toFixed(1)}% change this period, tracking ${fmt(
          latestTotal
        )} total units across ${
          whSignals.filter((w) => w.latest > 0).length
        } active warehouses. Warehouse distribution shows ${riskLevel} (HHI ${overallHHI.toFixed(
          2
        )})${
          tg
            ? `. Strongest growth signal: ${tg.name} (R²=${Math.round(
                tg.reg.r2 * 100
              )}%)`
            : ""
        }${td ? `. Key concern: ${td.name}'s declining trend` : ""}. ${
          recommendations.filter((r) => r.priority === "HIGH").length
        } high-priority actions identified.`;

        return {
          signals,
          recommendations,
          placement,
          retrospective,
          summary,
          custSignals,
          whSignals,
          overallHHI,
        };
      }

      // ═══════════════════════════════════════════════════════════════
      // INTELLIGENCE TAB
      // ═══════════════════════════════════════════════════════════════
      function IntelligenceTab({ reports }) {
        const intel = useMemo(() => runIntelligence(reports), [reports]);
        const [sec, setSec] = useState("overview");

        const SECS = [
          { id: "overview", label: "Summary" },
          { id: "signals", label: `Signals (${intel.signals.length})` },
          { id: "recs", label: `Actions (${intel.recommendations.length})` },
          { id: "placement", label: "Placement" },
          { id: "retro", label: "Retrospective" },
          { id: "forecast", label: "Forecast" },
        ];

        const sigColor = (t) =>
          t === "positive"
            ? "var(--teal)"
            : t === "negative"
            ? "var(--coral)"
            : t === "warning"
            ? "var(--amber)"
            : "var(--text2)";
        const sigBg = (t) =>
          t === "positive"
            ? "rgba(6,214,160,.06)"
            : t === "negative"
            ? "rgba(239,71,111,.06)"
            : t === "warning"
            ? "rgba(255,209,102,.06)"
            : "rgba(136,153,187,.04)";
        const priColor = (p) =>
          p === "HIGH"
            ? "var(--coral)"
            : p === "MEDIUM"
            ? "var(--amber)"
            : "var(--teal)";
        const priBg = (p) =>
          p === "HIGH"
            ? "rgba(239,71,111,.08)"
            : p === "MEDIUM"
            ? "rgba(255,209,102,.08)"
            : "rgba(6,214,160,.08)";
        const retroColor = (t) =>
          t === "win"
            ? "var(--teal)"
            : t === "miss"
            ? "var(--coral)"
            : t === "opportunity"
            ? "var(--amber)"
            : "var(--violet)";
        const retroIcon = (t) =>
          t === "win"
            ? "✓"
            : t === "miss"
            ? "✗"
            : t === "opportunity"
            ? "◎"
            : "◈";

        return (
          <div>
            <div className="panel" style={{ marginBottom: 14 }}>
              <div className="panel-body" style={{ padding: "10px 14px" }}>
                <div className="intel-nav">
                  {SECS.map((s) => (
                    <div
                      key={s.id}
                      className={`intel-btn${sec === s.id ? " on" : ""}`}
                      onClick={() => setSec(s.id)}
                    >
                      {s.label}
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {sec === "overview" && (
              <div className="fade-up">
                <div className="summary-block">{intel.summary}</div>
                <div className="intel-kpi-row">
                  {[
                    {
                      label: "Signals",
                      val: intel.signals.length,
                      color: "var(--teal)",
                    },
                    {
                      label: "High Priority",
                      val: intel.recommendations.filter(
                        (r) => r.priority === "HIGH"
                      ).length,
                      color: "var(--coral)",
                    },
                    {
                      label: "Placements to Fix",
                      val: intel.placement.length,
                      color: "var(--amber)",
                    },
                    {
                      label: "Retro Items",
                      val: intel.retrospective.length,
                      color: "var(--violet)",
                    },
                    {
                      label: "HHI Index",
                      val: intel.overallHHI?.toFixed(2) || "—",
                      color:
                        intel.overallHHI > 0.35
                          ? "var(--coral)"
                          : "var(--teal)",
                    },
                    {
                      label: "Active Customers",
                      val:
                        intel.custSignals?.filter((c) => c.latest > 0).length ||
                        0,
                      color: "var(--sky)",
                    },
                  ].map((k, i) => (
                    <div
                      key={i}
                      className="intel-kpi fade-up"
                      style={{ animationDelay: `${i * 0.07}s` }}
                    >
                      <div className="intel-kpi-label">{k.label}</div>
                      <div className="intel-kpi-val" style={{ color: k.color }}>
                        {k.val}
                      </div>
                    </div>
                  ))}
                </div>
                <div style={{ marginTop: 4 }}>
                  <div className="panel">
                    <div className="panel-head">
                      <span className="panel-title">
                        <span
                          className="panel-title-dot"
                          style={{ background: "var(--amber)" }}
                        />{" "}
                        Warehouse Trend Snapshot
                      </span>
                    </div>
                    <div className="panel-body">
                      <div
                        style={{
                          display: "grid",
                          gridTemplateColumns:
                            "repeat(auto-fill,minmax(190px,1fr))",
                          gap: 10,
                        }}
                      >
                        {intel.whSignals?.map((w, i) => {
                          const dir = w.reg.direction;
                          const dc =
                            dir === "rising"
                              ? "var(--teal)"
                              : dir === "falling"
                              ? "var(--coral)"
                              : "var(--muted)";
                          const arrow =
                            dir === "rising"
                              ? "↗"
                              : dir === "falling"
                              ? "↘"
                              : "→";
                          return (
                            <div
                              key={w.key}
                              style={{
                                background: "var(--surface2)",
                                border: "1px solid var(--border)",
                                borderRadius: 8,
                                padding: "12px 14px",
                                display: "flex",
                                alignItems: "center",
                                gap: 10,
                              }}
                            >
                              <div
                                style={{
                                  width: 8,
                                  height: 8,
                                  background: P[i],
                                  borderRadius: 2,
                                  flexShrink: 0,
                                }}
                              />
                              <div style={{ flex: 1 }}>
                                <div
                                  style={{
                                    fontSize: 12,
                                    fontWeight: 600,
                                    color: "var(--text)",
                                  }}
                                >
                                  {w.label}
                                </div>
                                <div
                                  style={{
                                    fontFamily: "JetBrains Mono",
                                    fontSize: 11,
                                    color: "var(--muted)",
                                  }}
                                >
                                  {fmt(w.latest)}
                                </div>
                              </div>
                              <span style={{ fontSize: 18, color: dc }}>
                                {arrow}
                              </span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                </div>
                {intel.recommendations.filter((r) => r.priority === "HIGH")
                  .length > 0 && (
                  <div className="panel" style={{ marginTop: 14 }}>
                    <div className="panel-head">
                      <span
                        className="panel-title"
                        style={{ color: "var(--coral)" }}
                      >
                        <span
                          className="panel-title-dot"
                          style={{ background: "var(--coral)" }}
                        />{" "}
                        High Priority Actions
                      </span>
                      <span
                        onClick={() => setSec("recs")}
                        style={{
                          fontSize: 11,
                          color: "var(--teal)",
                          cursor: "pointer",
                          fontFamily: "JetBrains Mono",
                        }}
                      >
                        See all →
                      </span>
                    </div>
                    <div
                      className="panel-body"
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        gap: 10,
                      }}
                    >
                      {intel.recommendations
                        .filter((r) => r.priority === "HIGH")
                        .map((r, i) => (
                          <div
                            key={i}
                            style={{
                              background: "rgba(239,71,111,.06)",
                              border: "1px solid rgba(239,71,111,.2)",
                              borderLeft: "3px solid var(--coral)",
                              borderRadius: 9,
                              padding: "14px 16px",
                            }}
                          >
                            <div
                              style={{
                                display: "flex",
                                justifyContent: "space-between",
                                gap: 10,
                                marginBottom: 6,
                              }}
                            >
                              <div
                                style={{
                                  fontSize: 13,
                                  fontWeight: 700,
                                  color: "var(--text)",
                                }}
                              >
                                {r.title}
                              </div>
                              <span
                                style={{
                                  background: "rgba(239,71,111,.15)",
                                  color: "var(--coral)",
                                  fontSize: 9,
                                  fontFamily: "JetBrains Mono",
                                  padding: "2px 8px",
                                  borderRadius: 4,
                                  whiteSpace: "nowrap",
                                  fontWeight: 700,
                                }}
                              >
                                HIGH
                              </span>
                            </div>
                            <div
                              style={{
                                fontSize: 12,
                                color: "var(--text2)",
                                marginBottom: 8,
                              }}
                            >
                              {r.rationale}
                            </div>
                            <div
                              style={{
                                fontSize: 11,
                                color: "var(--muted)",
                                background: "var(--surface)",
                                borderRadius: 6,
                                padding: "7px 12px",
                              }}
                            >
                              → {r.action}
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {sec === "signals" && (
              <div
                className="fade-up"
                style={{ display: "flex", flexDirection: "column" }}
              >
                {intel.signals.length === 0 && (
                  <div className="empty-state">
                    No significant signals detected.
                  </div>
                )}
                {intel.signals.map((s, i) => (
                  <div
                    key={i}
                    className="sig-card"
                    style={{
                      background: sigBg(s.type),
                      borderColor: sigColor(s.type),
                      borderLeftColor: sigColor(s.type),
                    }}
                  >
                    <div
                      style={{
                        display: "flex",
                        alignItems: "flex-start",
                        justifyContent: "space-between",
                        gap: 12,
                        marginBottom: 4,
                      }}
                    >
                      <div
                        style={{
                          display: "flex",
                          alignItems: "center",
                          gap: 10,
                        }}
                      >
                        <span style={{ fontSize: 16, color: sigColor(s.type) }}>
                          {s.icon}
                        </span>
                        <div>
                          <div
                            className="sig-label"
                            style={{ color: sigColor(s.type) }}
                          >
                            {s.category}
                          </div>
                          <div className="sig-title">{s.title}</div>
                        </div>
                      </div>
                      <div style={{ minWidth: 90 }}>
                        <div
                          style={{
                            fontSize: 9,
                            fontFamily: "JetBrains Mono",
                            color: "var(--muted)",
                            marginBottom: 4,
                            textAlign: "right",
                          }}
                        >
                          CONFIDENCE
                        </div>
                        <ConfBar value={s.confidence} />
                      </div>
                    </div>
                    <div className="sig-detail" style={{ paddingLeft: 26 }}>
                      {s.detail}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {sec === "recs" && (
              <div className="fade-up">
                {["HIGH", "MEDIUM", "LOW"].map((pri) => {
                  const recs = intel.recommendations.filter(
                    (r) => r.priority === pri
                  );
                  if (!recs.length) return null;
                  return (
                    <div key={pri} style={{ marginBottom: 20 }}>
                      <div
                        style={{
                          display: "flex",
                          alignItems: "center",
                          gap: 10,
                          marginBottom: 10,
                        }}
                      >
                        <div
                          style={{
                            width: 8,
                            height: 8,
                            borderRadius: 2,
                            background: priColor(pri),
                          }}
                        />
                        <span
                          style={{
                            fontFamily: "JetBrains Mono",
                            fontSize: 10,
                            color: priColor(pri),
                            fontWeight: 700,
                            textTransform: "uppercase",
                            letterSpacing: ".08em",
                          }}
                        >
                          {pri} PRIORITY · {recs.length}
                        </span>
                      </div>
                      {recs.map((r, i) => (
                        <div
                          key={i}
                          className="rec-card"
                          style={{
                            background: priBg(r.priority),
                            borderColor: `${priColor(r.priority)}33`,
                          }}
                        >
                          <div className="rec-head">
                            <div>
                              <div className="rec-title">{r.title}</div>
                              <div
                                style={{
                                  fontSize: 10,
                                  fontFamily: "JetBrains Mono",
                                  color: "var(--muted)",
                                  marginTop: 2,
                                }}
                              >
                                {r.type}
                              </div>
                            </div>
                            <div style={{ textAlign: "right", minWidth: 100 }}>
                              <div
                                style={{
                                  fontSize: 9,
                                  fontFamily: "JetBrains Mono",
                                  color: "var(--muted)",
                                  marginBottom: 4,
                                }}
                              >
                                CONFIDENCE
                              </div>
                              <ConfBar value={r.confidence} />
                            </div>
                          </div>
                          <div className="rec-rationale">{r.rationale}</div>
                          <div className="rec-action">
                            <span
                              style={{
                                color: priColor(r.priority),
                                fontFamily: "JetBrains Mono",
                                fontSize: 10,
                                fontWeight: 700,
                              }}
                            >
                              → ACTION:{" "}
                            </span>
                            {r.action}
                          </div>
                          <div className="rec-impact">📈 {r.impact}</div>
                        </div>
                      ))}
                    </div>
                  );
                })}
              </div>
            )}

            {sec === "placement" && (
              <div className="fade-up">
                <div className="panel" style={{ marginBottom: 14 }}>
                  <div className="panel-head">
                    <span className="panel-title">
                      <span
                        className="panel-title-dot"
                        style={{ background: "var(--amber)" }}
                      />{" "}
                      Strategic Placement Optimizer
                    </span>
                  </div>
                  <div className="panel-body">
                    {intel.placement.length === 0 ? (
                      <div className="empty-state">
                        <div style={{ fontSize: 32, marginBottom: 10 }}>✓</div>
                        Placement is well-balanced. No reallocation needed.
                      </div>
                    ) : (
                      intel.placement.map((p, i) => (
                        <div key={i} className="place-card">
                          <div
                            style={{
                              display: "flex",
                              justifyContent: "space-between",
                              gap: 10,
                              marginBottom: 10,
                            }}
                          >
                            <div>
                              <div
                                style={{
                                  fontSize: 14,
                                  fontWeight: 700,
                                  color: "var(--text)",
                                  marginBottom: 2,
                                }}
                              >
                                {p.customer}
                              </div>
                              <div
                                style={{
                                  fontFamily: "JetBrains Mono",
                                  fontSize: 10,
                                  color: "var(--muted)",
                                }}
                              >
                                WP {p.wp} · {fmt(p.stockQty)} units
                              </div>
                            </div>
                            <div style={{ minWidth: 100 }}>
                              <ConfBar value={p.confidence} />
                            </div>
                          </div>
                          <div className="place-arrow">
                            <div
                              className="place-box"
                              style={{
                                background: "rgba(239,71,111,.08)",
                                borderColor: "rgba(239,71,111,.3)",
                              }}
                            >
                              <div
                                style={{
                                  fontSize: 9,
                                  fontFamily: "JetBrains Mono",
                                  color: "var(--coral)",
                                  marginBottom: 2,
                                }}
                              >
                                CURRENT
                              </div>
                              <div
                                style={{
                                  fontSize: 13,
                                  fontWeight: 700,
                                  color: "var(--text)",
                                }}
                              >
                                {p.currentWH}
                              </div>
                              <div
                                style={{ fontSize: 10, color: "var(--muted)" }}
                              >
                                {p.currentWHLoad}% load
                              </div>
                            </div>
                            <span
                              style={{ fontSize: 20, color: "var(--teal)" }}
                            >
                              →
                            </span>
                            <div
                              className="place-box"
                              style={{
                                background: "rgba(6,214,160,.08)",
                                borderColor: "rgba(6,214,160,.3)",
                              }}
                            >
                              <div
                                style={{
                                  fontSize: 9,
                                  fontFamily: "JetBrains Mono",
                                  color: "var(--teal)",
                                  marginBottom: 2,
                                }}
                              >
                                SUGGESTED
                              </div>
                              <div
                                style={{
                                  fontSize: 13,
                                  fontWeight: 700,
                                  color: "var(--text)",
                                }}
                              >
                                {p.suggestedWH}
                              </div>
                              <div
                                style={{ fontSize: 10, color: "var(--muted)" }}
                              >
                                {p.suggestedWHLoad}% load
                              </div>
                            </div>
                          </div>
                          <div
                            style={{
                              fontSize: 12,
                              color: "var(--text2)",
                              marginBottom: 4,
                            }}
                          >
                            {p.reason}
                          </div>
                          <div
                            style={{
                              fontFamily: "JetBrains Mono",
                              fontSize: 10,
                              color: "var(--teal)",
                            }}
                          >
                            Benefit: {p.benefit}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
                <div className="panel">
                  <div className="panel-head">
                    <span className="panel-title">Warehouse Load Balance</span>
                  </div>
                  <div className="panel-body">
                    {intel.whSignals
                      ?.filter((w) => w.latest > 0)
                      .map((w, i) => {
                        const pct2 = Math.round(w.share * 100);
                        const bc =
                          w.share > 0.35
                            ? "var(--coral)"
                            : w.share > 0.25
                            ? "var(--amber)"
                            : "var(--teal)";
                        return (
                          <div key={w.key} className="wh-load-row">
                            <div className="wh-load-meta">
                              <div className="wh-load-name">
                                <span
                                  style={{
                                    width: 8,
                                    height: 8,
                                    background: P[i],
                                    borderRadius: 2,
                                    display: "inline-block",
                                  }}
                                />
                                {w.label}
                              </div>
                              <div
                                className="wh-load-pct"
                                style={{ color: bc }}
                              >
                                {pct2}%
                              </div>
                            </div>
                            <div className="wh-load-track">
                              <div
                                className="wh-load-fill"
                                style={{ width: `${pct2}%`, background: bc }}
                              />
                            </div>
                            <div className="wh-load-sub">
                              <span>{fmt(w.latest)} units</span>
                              <span>{w.custCount} customers</span>
                            </div>
                          </div>
                        );
                      })}
                  </div>
                </div>
              </div>
            )}

            {sec === "retro" && (
              <div className="fade-up">
                <div className="panel" style={{ marginBottom: 14 }}>
                  <div className="panel-head">
                    <span className="panel-title">
                      <span
                        className="panel-title-dot"
                        style={{ background: "var(--violet)" }}
                      />{" "}
                      Period Retrospective
                    </span>
                  </div>
                  <div className="panel-body">
                    {intel.retrospective.length === 0 ? (
                      <div className="empty-state">
                        Need 3+ reports for retrospective analysis.
                      </div>
                    ) : (
                      intel.retrospective.map((r, i) => (
                        <div
                          key={i}
                          className="retro-card"
                          style={{ borderLeftColor: retroColor(r.type) }}
                        >
                          <div className="retro-title">
                            <span
                              style={{
                                width: 20,
                                height: 20,
                                borderRadius: 4,
                                background: `${retroColor(r.type)}20`,
                                color: retroColor(r.type),
                                display: "inline-flex",
                                alignItems: "center",
                                justifyContent: "center",
                                fontSize: 11,
                                fontWeight: 700,
                              }}
                            >
                              {retroIcon(r.type)}
                            </span>
                            {r.title}
                          </div>
                          <div className="retro-detail">{r.detail}</div>
                          <div className="retro-lesson">
                            <span
                              style={{
                                color: "var(--teal)",
                                fontWeight: 600,
                                fontFamily: "JetBrains Mono",
                                fontSize: 10,
                              }}
                            >
                              Lesson:{" "}
                            </span>
                            {r.lesson}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
                <div className="panel">
                  <div className="panel-head">
                    <span className="panel-title">
                      What To Do Better Next Cycle
                    </span>
                  </div>
                  <div className="panel-body">
                    {[
                      intel.custSignals?.filter(
                        (c) => c.whConcentrated && c.latest > 3000
                      ).length > 0 && {
                        icon: "◎",
                        color: "var(--amber)",
                        title: "Diversify single-warehouse customers",
                        detail: `${
                          intel.custSignals.filter(
                            (c) => c.whConcentrated && c.latest > 3000
                          ).length
                        } high-value customers are 100% in one warehouse.`,
                      },
                      intel.overallHHI > 0.3 && {
                        icon: "▦",
                        color: "var(--coral)",
                        title: "Rebalance warehouse utilisation",
                        detail: `HHI of ${intel.overallHHI?.toFixed(
                          2
                        )} is above optimal (0.25). Move stock to underutilised locations.`,
                      },
                      intel.custSignals?.filter(
                        (c) => c.vol > 0.35 && c.latest > 2000
                      ).length > 0 && {
                        icon: "≈",
                        color: "var(--sky)",
                        title: "Set safety buffers for volatile customers",
                        detail: `${
                          intel.custSignals.filter(
                            (c) => c.vol > 0.35 && c.latest > 2000
                          ).length
                        } customers show high stock volatility.`,
                      },
                      {
                        icon: "◷",
                        color: "var(--violet)",
                        title: "Increase reporting frequency",
                        detail: `More frequent snapshots improve trend detection accuracy for top-10 customers.`,
                      },
                    ]
                      .filter(Boolean)
                      .map((item, i) => (
                        <div
                          key={i}
                          style={{
                            display: "flex",
                            gap: 12,
                            padding: "12px 14px",
                            background: "var(--surface2)",
                            border: "1px solid var(--border)",
                            borderRadius: 8,
                            marginBottom: 8,
                          }}
                        >
                          <span
                            style={{
                              fontSize: 18,
                              color: item.color,
                              flexShrink: 0,
                            }}
                          >
                            {item.icon}
                          </span>
                          <div>
                            <div
                              style={{
                                fontSize: 13,
                                fontWeight: 600,
                                color: "var(--text)",
                                marginBottom: 3,
                              }}
                            >
                              {item.title}
                            </div>
                            <div
                              style={{ fontSize: 12, color: "var(--text2)" }}
                            >
                              {item.detail}
                            </div>
                          </div>
                        </div>
                      ))}
                  </div>
                </div>
              </div>
            )}

            {sec === "forecast" && (
              <div className="fade-up">
                <div className="panel">
                  <div className="panel-head">
                    <span className="panel-title">
                      <span
                        className="panel-title-dot"
                        style={{ background: "var(--teal)" }}
                      />{" "}
                      Next Cycle Forecast
                    </span>
                    <span
                      style={{
                        fontSize: 10,
                        fontFamily: "JetBrains Mono",
                        color: "var(--muted)",
                      }}
                    >
                      Linear trend projection
                    </span>
                  </div>
                  <div className="panel-body">
                    {intel.custSignals &&
                      (() => {
                        const projTotal = intel.custSignals.reduce(
                          (s, c) => s + c.proj,
                          0
                        );
                        const curTotal = intel.custSignals.reduce(
                          (s, c) => s + c.latest,
                          0
                        );
                        const delta = projTotal - curTotal;
                        return (
                          <>
                            <div
                              style={{
                                background: "var(--surface2)",
                                border: "1px solid rgba(6,214,160,.2)",
                                borderRadius: 10,
                                padding: "18px 20px",
                                marginBottom: 18,
                                textAlign: "center",
                              }}
                            >
                              <div
                                style={{
                                  fontFamily: "JetBrains Mono",
                                  fontSize: 10,
                                  color: "var(--muted)",
                                  marginBottom: 8,
                                  textTransform: "uppercase",
                                  letterSpacing: ".09em",
                                }}
                              >
                                Projected Total Next Cycle
                              </div>
                              <div
                                style={{
                                  fontFamily: "Syne",
                                  fontSize: 42,
                                  fontWeight: 800,
                                  color: "var(--teal)",
                                  letterSpacing: "-.04em",
                                  marginBottom: 6,
                                }}
                              >
                                {fmt(projTotal)}
                              </div>
                              <div
                                style={{
                                  fontSize: 12,
                                  color:
                                    delta >= 0 ? "var(--teal)" : "var(--coral)",
                                  fontFamily: "JetBrains Mono",
                                }}
                              >
                                {delta >= 0 ? "▲" : "▼"} {fmt(Math.abs(delta))}{" "}
                                units ({delta >= 0 ? "+" : ""}
                                {curTotal > 0
                                  ? ((delta / curTotal) * 100).toFixed(1)
                                  : "0"}
                                %)
                              </div>
                            </div>
                            <div className="tbl-wrap">
                              <table>
                                <thead>
                                  <tr>
                                    <th style={{ textAlign: "left" }}>
                                      Customer
                                    </th>
                                    <th>Current</th>
                                    <th>Projected</th>
                                    <th>Change</th>
                                    <th>Trend</th>
                                    <th>Confidence</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {intel.custSignals
                                    .filter((c) => c.latest > 0 || c.proj > 0)
                                    .sort((a, b) => b.latest - a.latest)
                                    .map((c, i) => {
                                      const d = c.proj - c.latest;
                                      const dp =
                                        c.latest > 0 ? (d / c.latest) * 100 : 0;
                                      const arrow =
                                        c.reg.direction === "rising"
                                          ? "↗"
                                          : c.reg.direction === "falling"
                                          ? "↘"
                                          : "→";
                                      const ac =
                                        c.reg.direction === "rising"
                                          ? "var(--teal)"
                                          : c.reg.direction === "falling"
                                          ? "var(--coral)"
                                          : "var(--muted)";
                                      return (
                                        <tr key={i}>
                                          <td style={{ textAlign: "left" }}>
                                            <span
                                              style={{
                                                display: "flex",
                                                alignItems: "center",
                                                gap: 6,
                                              }}
                                            >
                                              <span
                                                style={{
                                                  width: 6,
                                                  height: 6,
                                                  background: P[i % P.length],
                                                  borderRadius: 2,
                                                  display: "inline-block",
                                                  flexShrink: 0,
                                                }}
                                              />
                                              <span
                                                style={{
                                                  color: "var(--text)",
                                                  fontWeight: 500,
                                                  fontSize: 12,
                                                }}
                                              >
                                                {c.name}
                                              </span>
                                            </span>
                                          </td>
                                          <td
                                            style={{
                                              fontFamily: "JetBrains Mono",
                                              fontSize: 11,
                                            }}
                                          >
                                            {fmt(c.latest)}
                                          </td>
                                          <td
                                            className="fc-proj"
                                            style={{ color: "var(--text)" }}
                                          >
                                            {fmt(c.proj)}
                                          </td>
                                          <td
                                            style={{
                                              color:
                                                d >= 0
                                                  ? "var(--teal)"
                                                  : "var(--coral)",
                                              fontFamily: "JetBrains Mono",
                                              fontSize: 11,
                                            }}
                                          >
                                            {d >= 0 ? "+" : ""}
                                            {dp.toFixed(1)}%
                                          </td>
                                          <td
                                            style={{
                                              color: ac,
                                              fontSize: 16,
                                              textAlign: "center",
                                            }}
                                          >
                                            {arrow}
                                          </td>
                                          <td style={{ minWidth: 100 }}>
                                            <ConfBar value={c.reg.r2} />
                                          </td>
                                        </tr>
                                      );
                                    })}
                                </tbody>
                              </table>
                            </div>
                          </>
                        );
                      })()}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // ═══════════════════════════════════════════════════════════════
      // TUTORIAL SYSTEM
      // ═══════════════════════════════════════════════════════════════
      const TUTORIAL_STEPS = [
        {
          id: "welcome",
          eyebrow: "Welcome to PE Signal Room",
          title: "Your Stock Intelligence Command Centre",
          icon: "◆",
          iconBg: "linear-gradient(135deg,#06d6a0,#38bdf8)",
          lead: "This platform gives you real-time visibility into Premier Energies' major customer stock positions across all 8 warehouses. This tutorial walks you through every feature — what it shows, how it's calculated, and what decisions it helps you make.",
          content: () => (
            <>
              <div className="tut-section-label">What you can do here</div>
              <div className="tut-cards">
                {[
                  {
                    icon: "◈",
                    color: "var(--teal)",
                    title: "Monitor Portfolio",
                    desc: "Track total units held across all customers and warehouses in real-time with period-over-period comparison.",
                  },
                  {
                    icon: "◎",
                    color: "var(--sky)",
                    title: "Analyse Trends",
                    desc: "See whether each customer or warehouse is growing, shrinking, or stable over the 8 reporting periods.",
                  },
                  {
                    icon: "▦",
                    color: "var(--amber)",
                    title: "Drill Into Data",
                    desc: "Click any warehouse, customer, or cell to enter a nested detail view. 3 levels of drill-down available.",
                  },
                  {
                    icon: "◆",
                    color: "var(--violet)",
                    title: "Get AI Signals",
                    desc: "The Intelligence engine auto-detects anomalies, risks, growth signals, and strategic placement gaps.",
                  },
                ].map((c, i) => (
                  <div
                    key={i}
                    className="tut-card"
                    style={{ borderLeftColor: c.color }}
                  >
                    <div className="tut-card-icon" style={{ color: c.color }}>
                      {c.icon}
                    </div>
                    <div className="tut-card-title">{c.title}</div>
                    <div className="tut-card-desc">{c.desc}</div>
                  </div>
                ))}
              </div>
              <div className="tut-tip">
                <div className="tut-tip-icon">💡</div>
                <div className="tut-tip-text">
                  <strong>Navigation:</strong> Use the icon rail on the left to
                  switch between tabs. Click any chart bar, warehouse card, or
                  table row to drill deeper. The breadcrumb at the top always
                  shows where you are.
                </div>
              </div>
            </>
          ),
        },
        {
          id: "overview",
          eyebrow: "Tab 1 — Overview",
          title: "The Portfolio Command View",
          icon: "◈",
          iconBg: "linear-gradient(135deg,#06d6a0,#06b6d4)",
          lead: "The Overview tab is your starting point. It shows the health of the entire stock portfolio at a glance — hero totals, warehouse distribution, top customers, and the portfolio trend over time.",
          content: () => (
            <>
              <div className="tut-section-label">What each element shows</div>
              <div className="tut-steps">
                {[
                  {
                    title: "Hero Strip",
                    desc: "Displays <strong>Total Stock Units</strong> for the selected report date, the <strong>period delta</strong> (change vs previous period in units and %), your <strong>top customer</strong> by volume, top warehouse, and total active customer count. Numbers animate on load to draw attention to changes.",
                  },
                  {
                    title: "Warehouse Distribution (Bar Chart)",
                    desc: "Each bar is a warehouse. <strong>Click any bar to drill into that warehouse</strong> — you'll see its customer breakdown, trend, and all contributing customers.",
                  },
                  {
                    title: "Top 10 Customers (Horizontal Bar)",
                    desc: "The 10 largest customers by total stock. <strong>Click any bar to drill into that customer</strong> — you'll see their multi-warehouse breakdown and trend over all periods.",
                  },
                  {
                    title: "Portfolio Stock Trend (Area Chart)",
                    desc: "Shows how total units have moved across all 8 report dates. A rising chart means stock is building; falling means it's being dispatched or demand is dropping.",
                  },
                  {
                    title: "Warehouse KPI Cards (bottom row)",
                    desc: "One card per warehouse. Shows current units, % of total, and period delta. <strong>Click any card to drill in.</strong> The colour bar at the top identifies the warehouse.",
                  },
                ].map((s, i) => (
                  <div key={i} className="tut-step">
                    <div className="tut-step-num">{i + 1}</div>
                    <div className="tut-step-content">
                      <strong>{s.title}</strong> —{" "}
                      <span dangerouslySetInnerHTML={{ __html: s.desc }} />
                    </div>
                  </div>
                ))}
              </div>
              <div className="tut-tip">
                <div className="tut-tip-icon">🎯</div>
                <div className="tut-tip-text">
                  <strong>Decision hint:</strong> If the hero delta is negative
                  but one warehouse card is positive, that warehouse is
                  accumulating while others dispatch — investigate whether
                  that's intentional or a bottleneck.
                </div>
              </div>
            </>
          ),
        },
        {
          id: "trends",
          eyebrow: "Tab 2 — Trends",
          title: "Time-Series & Comparative Analysis",
          icon: "◎",
          iconBg: "linear-gradient(135deg,#38bdf8,#818cf8)",
          lead: "The Trends tab shows how stock levels have changed across all 8 report periods. You can view by warehouse, by customer, or as a stacked composition — switching between views reveals different stories in the same data.",
          content: () => (
            <>
              <div className="tut-section-label">
                Three charts, three perspectives
              </div>
              <div className="tut-cards">
                {[
                  {
                    icon: "—",
                    color: "var(--sky)",
                    title: "Warehouse Line Chart",
                    desc: "Each coloured line is a warehouse. Crossing lines indicate stock migration between locations. A line hitting zero means that warehouse has been emptied.",
                  },
                  {
                    icon: "—",
                    color: "var(--teal)",
                    title: "Customer Trend Chart",
                    desc: "Top 8 customers plotted over time. Use the WP/warehouse pill selector above the chart to see how stock behaves per warehouse — not just the grand total.",
                  },
                  {
                    icon: "—",
                    color: "var(--amber)",
                    title: "Stacked Area Chart",
                    desc: "Shows the composition of total stock over time. If one colour expands while total stays flat, stock is concentrating. If the whole area grows, total stock is building.",
                  },
                ].map((c, i) => (
                  <div
                    key={i}
                    className="tut-card"
                    style={{ borderLeftColor: c.color }}
                  >
                    <div className="tut-card-title">{c.title}</div>
                    <div className="tut-card-desc">{c.desc}</div>
                  </div>
                ))}
              </div>
              <div className="tut-divider" />
              <div className="tut-section-label">What patterns to look for</div>
              <table className="tut-table">
                <thead>
                  <tr>
                    <th>Pattern</th>
                    <th>What it means</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {[
                    [
                      "Steady upward slope",
                      "Stock building faster than dispatch",
                      "Review if dispatch schedule is on track or if customer is accumulating",
                    ],
                    [
                      "Sudden spike then flat",
                      "One-time large inbound shipment",
                      "Confirm dispatch plan is in place before next period",
                    ],
                    [
                      "Gradual decline",
                      "Regular dispatch occurring — healthy",
                      "Monitor rate; if it flattens before zero, dispatch may have paused",
                    ],
                    [
                      "Sharp drop to zero",
                      "Complete dispatch or stock-out",
                      "Verify if intentional. If unplanned, flag for replenishment",
                    ],
                    [
                      "Oscillating / volatile",
                      "Irregular order pattern",
                      "Consider maintaining a safety buffer for this customer",
                    ],
                  ].map((r, i) => (
                    <tr key={i}>
                      <td style={{ color: "var(--text)", fontWeight: 600 }}>
                        {r[0]}
                      </td>
                      <td>{r[1]}</td>
                      <td style={{ color: "var(--teal)" }}>{r[2]}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </>
          ),
        },
        {
          id: "warehouses",
          eyebrow: "Tab 3 — Warehouses",
          title: "Facility-Level Stock Mapping",
          icon: "▦",
          iconBg: "linear-gradient(135deg,#ffd166,#fb923c)",
          lead: "The Warehouses tab gives you a per-facility view of stock concentration, customer density, and period momentum — all on one screen. Each tile is a clickable entry point to a full warehouse drill-down.",
          content: () => (
            <>
              <div className="tut-section-label">Reading a Warehouse Tile</div>
              <div className="tut-steps">
                {[
                  {
                    title: "Colour bar (top)",
                    desc: "Uniquely identifies the warehouse across all charts throughout the dashboard. Consistent colour coding means a bar in any chart refers to the same warehouse.",
                  },
                  {
                    title: "Ghost percentage (top-right)",
                    desc: "Shows this warehouse's <strong>share of total portfolio stock</strong>. A large ghost number means high concentration — which may represent a risk.",
                  },
                  {
                    title: "Mini sparkline bars",
                    desc: "The small bar chart shows this warehouse's stock level across all 8 periods. The <strong>last bar (brightest)</strong> is the current period. This lets you spot trends without opening a chart.",
                  },
                  {
                    title: "Footer: customers & delta",
                    desc: "Left shows how many customers currently have stock here. Right shows the <strong>period-over-period change in units</strong> — green = increase, red = decrease.",
                  },
                ].map((s, i) => (
                  <div key={i} className="tut-step">
                    <div className="tut-step-num">{i + 1}</div>
                    <div className="tut-step-content">
                      <strong>{s.title}</strong> —{" "}
                      <span dangerouslySetInnerHTML={{ __html: s.desc }} />
                    </div>
                  </div>
                ))}
              </div>
              <div className="tut-divider" />
              <div className="tut-section-label">
                Inside the Warehouse Drill-Down
              </div>
              <div
                className="tut-cards"
                style={{ gridTemplateColumns: "1fr 1fr" }}
              >
                {[
                  {
                    color: "var(--teal)",
                    title: "Trend Chart",
                    desc: "Area chart of this warehouse's total stock across all periods. Shows whether it's loading or emptying.",
                  },
                  {
                    color: "var(--amber)",
                    title: "Top Customers Bar",
                    desc: "Which customers are responsible for most of this warehouse's stock. Click bars to cross-drill into customer view.",
                  },
                  {
                    color: "var(--sky)",
                    title: "Customer Table",
                    desc: "Full list of customers in this warehouse, sortable by volume. Shows each customer's share and links to their detail.",
                  },
                  {
                    color: "var(--violet)",
                    title: "KPI Stats",
                    desc: "4 headline numbers: total units, period delta, active customers, and share of total portfolio.",
                  },
                ].map((c, i) => (
                  <div
                    key={i}
                    className="tut-card"
                    style={{ borderLeftColor: c.color }}
                  >
                    <div className="tut-card-title">{c.title}</div>
                    <div className="tut-card-desc">{c.desc}</div>
                  </div>
                ))}
              </div>
              <div className="tut-tip">
                <div className="tut-tip-icon">🔍</div>
                <div className="tut-tip-text">
                  <strong>Drill path:</strong> Warehouses tab → Click tile →
                  Warehouse Detail (Level 1) → Click customer bar or table row →
                  Customer Detail (Level 2) → Click warehouse row → Customer ×
                  Warehouse Cross-Drill (Level 3)
                </div>
              </div>
            </>
          ),
        },
        {
          id: "data",
          eyebrow: "Tab 4 — Data Table",
          title: "Granular Row-Level Exploration",
          icon: "≡",
          iconBg: "linear-gradient(135deg,#06d6a0,#a78bfa)",
          lead: "The Data Table gives you full row-level access to the underlying data — every customer, every warehouse column, every unit count. This is where you search, sort, filter, and export.",
          content: () => (
            <>
              <div className="tut-section-label">How to use the table</div>
              <div className="tut-steps">
                {[
                  {
                    title: "Report date chips (top strip)",
                    desc: "Switch between the 8 reporting periods. Each selection reloads the entire table for that date. The <strong>active chip is teal</strong>.",
                  },
                  {
                    title: "Customer legend (left sidebar)",
                    desc: "A list of all customers with their colour dot and current total. <strong>Click any customer to hide/show their rows</strong> — useful for isolating specific accounts in the trend charts above.",
                  },
                  {
                    title: "Column headers (click to sort)",
                    desc: "Click any column header to sort ascending. Click again for descending. The <strong>active sort column turns teal</strong> and shows an arrow direction.",
                  },
                  {
                    title: "Table cells — warehouse columns",
                    desc: "Cells showing a number are clickable — they drill into the <strong>Customer × Warehouse cross-view</strong>, showing exactly how that specific customer's stock in that specific warehouse has moved over time.",
                  },
                  {
                    title: "Zero values shown as —",
                    desc: "A dash means zero units. This is intentional — it separates 'no stock' from 'small stock'. Zeros are dimmed; values above 50,000 are highlighted amber.",
                  },
                  {
                    title: "Grand Total row (footer)",
                    desc: "Pinned totals for each column. The rightmost cell is the overall portfolio total for the selected period.",
                  },
                ].map((s, i) => (
                  <div key={i} className="tut-step">
                    <div className="tut-step-num">{i + 1}</div>
                    <div className="tut-step-content">
                      <strong>{s.title}</strong> —{" "}
                      <span dangerouslySetInnerHTML={{ __html: s.desc }} />
                    </div>
                  </div>
                ))}
              </div>
              <div className="tut-divider" />
              <div className="tut-section-label">
                Warehouse column abbreviations
              </div>
              <div className="tut-metrics">
                {[
                  { dot: "#06d6a0", label: "ANN", def: "Annaram" },
                  { dot: "#ffd166", label: "KOT", def: "Kothur" },
                  { dot: "#ef476f", label: "NRK", def: "Narkhuda" },
                  { dot: "#38bdf8", label: "P2", def: "P2 Warehouse" },
                  { dot: "#a78bfa", label: "P4", def: "P4 Warehouse" },
                  { dot: "#fb923c", label: "P5", def: "P5 Warehouse" },
                  { dot: "#34d399", label: "P6", def: "P6 Warehouse" },
                  { dot: "#f472b6", label: "PPK", def: "Prime Pack" },
                ].map((m, i) => (
                  <div key={i} className="tut-metric">
                    <div
                      className="tut-metric-dot"
                      style={{ background: m.dot }}
                    />
                    <span className="tut-metric-label">{m.label}</span>
                    <span className="tut-metric-def">= {m.def}</span>
                  </div>
                ))}
              </div>
              <div className="tut-warn">
                <div className="tut-tip-icon">⬇</div>
                <div className="tut-tip-text" style={{ color: "var(--text2)" }}>
                  Use the{" "}
                  <strong style={{ color: "var(--amber)" }}>
                    Export button
                  </strong>{" "}
                  (top-right) to download the current filtered view as CSV, or
                  the full report/all reports as JSON for further analysis in
                  Excel or Python.
                </div>
              </div>
            </>
          ),
        },
        {
          id: "intelligence",
          eyebrow: "Tab 5 — Intelligence",
          title: "AI-Powered Signal Detection",
          icon: "◆",
          iconBg: "linear-gradient(135deg,#a78bfa,#ef476f)",
          lead: "The Intelligence tab runs 7 statistical algorithms across all historical data to automatically surface risks, growth signals, anomalies, and strategic recommendations. It updates on every new report upload.",
          content: () => (
            <>
              <div className="tut-section-label">
                The 7 algorithms explained
              </div>
              <div
                style={{
                  display: "flex",
                  flexDirection: "column",
                  gap: 10,
                  marginBottom: 16,
                }}
              >
                {[
                  {
                    name: "Linear Regression",
                    color: "var(--teal)",
                    formula:
                      "slope = Σ(x−x̄)(y−ȳ) / Σ(x−x̄)²\nR² = correlation coefficient (0→1)",
                    desc: "Fits a straight line through all stock readings for each customer. The slope tells you direction (rising/falling/stable). R² tells you how reliable that direction is — values above 0.6 are considered high-confidence trends.",
                  },
                  {
                    name: "Z-Score Anomaly Detection",
                    color: "var(--coral)",
                    formula: "Z = (x − μ) / σ\nFlag if |Z| > 1.8",
                    desc: "Measures how far the latest reading deviates from that customer's own historical average. A Z of +2.5 means the current stock is 2.5 standard deviations above normal — a strong spike. Negative Z means an unusual drop.",
                  },
                  {
                    name: "HHI Concentration Index",
                    color: "var(--amber)",
                    formula: "HHI = Σ(share_i)²\nRisk: HHI > 0.35",
                    desc: "The Herfindahl-Hirschman Index measures warehouse concentration. If all stock is in one warehouse, HHI = 1.0 (maximum risk). If evenly spread across 8, HHI ≈ 0.125. Values above 0.35 trigger a concentration warning.",
                  },
                  {
                    name: "Momentum Score",
                    color: "var(--sky)",
                    formula:
                      "momentum = (recent_delta − avg_delta) / |avg_delta|\nRange: −3 to +3",
                    desc: "Compares the most recent period's rate of change against the historical average rate. A score above +1.2 means the customer is accelerating — growing faster than their historical trend suggests.",
                  },
                  {
                    name: "Volatility (CV)",
                    color: "var(--violet)",
                    formula: "CV = σ / μ\nHigh: CV > 0.35",
                    desc: "Coefficient of Variation. A high CV means stock swings unpredictably between periods, making planning harder. Customers with CV > 35% are flagged as requiring safety buffers.",
                  },
                  {
                    name: "Linear Projection",
                    color: "var(--teal)",
                    formula: "next = last_value + slope",
                    desc: "Projects what the next period's stock level will be based on the current trend. Used in the Forecast section. High R² = trustworthy projection; low R² = treat with caution.",
                  },
                  {
                    name: "ABC Classification",
                    color: "var(--amber)",
                    formula: "A: top 70% of volume\nB: next 20%\nC: bottom 10%",
                    desc: "Classifies customers by their stock volume contribution. Class A customers are your highest-priority accounts — they represent the majority of your stock and require the closest monitoring.",
                  },
                ].map((a, i) => (
                  <div
                    key={i}
                    style={{
                      background: "var(--surface2)",
                      border: "1px solid var(--border)",
                      borderLeft: `3px solid ${a.color}`,
                      borderRadius: 10,
                      padding: "14px 16px",
                    }}
                  >
                    <div
                      style={{
                        display: "flex",
                        alignItems: "flex-start",
                        gap: 12,
                        flexWrap: "wrap",
                      }}
                    >
                      <div style={{ flex: "1 1 200px" }}>
                        <div
                          style={{
                            fontFamily: "JetBrains Mono",
                            fontSize: 10,
                            color: a.color,
                            fontWeight: 700,
                            textTransform: "uppercase",
                            letterSpacing: ".08em",
                            marginBottom: 4,
                          }}
                        >
                          {a.name}
                        </div>
                        <div
                          style={{
                            fontSize: 12,
                            color: "var(--text2)",
                            lineHeight: 1.55,
                          }}
                        >
                          {a.desc}
                        </div>
                      </div>
                      <div
                        className="tut-formula"
                        style={{
                          flex: "0 0 auto",
                          minWidth: 200,
                          fontSize: 11,
                          margin: 0,
                        }}
                      >
                        <div className="f-comment">Formula</div>
                        <div style={{ whiteSpace: "pre", marginTop: 4 }}>
                          {a.formula}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </>
          ),
        },
        {
          id: "signals",
          eyebrow: "Intelligence — Signals & Recommendations",
          title: "Reading the Signal Dashboard",
          icon: "⚡",
          iconBg: "linear-gradient(135deg,#ffd166,#ef476f)",
          lead: "The Intelligence tab has 6 sections. Here's how to read each one and what action it calls for.",
          content: () => (
            <>
              <div className="tut-section-label">
                The 6 intelligence sections
              </div>
              <table className="tut-table" style={{ marginBottom: 16 }}>
                <thead>
                  <tr>
                    <th>Section</th>
                    <th>What it shows</th>
                    <th>When to use it</th>
                  </tr>
                </thead>
                <tbody>
                  {[
                    [
                      "Executive Summary",
                      "Auto-written paragraph summarising portfolio direction, HHI risk, top grower, top concern, and action count. Updates on every upload.",
                      "Start here every time you open the dashboard.",
                    ],
                    [
                      "Signals",
                      "Auto-detected events: rising/falling trends, anomaly spikes/drops, stale stock, high volatility — each with a confidence bar.",
                      "Review after each new report upload to catch emerging issues early.",
                    ],
                    [
                      "Recommendations (Actions)",
                      "Prioritised HIGH / MEDIUM / LOW actions with rationale, specific action text, and expected impact. Covers rebalancing, pre-positioning, dispatch acceleration, resilience.",
                      "Use for weekly planning meetings and dispatch scheduling.",
                    ],
                    [
                      "Placement Optimizer",
                      "Identifies customers in overloaded warehouses and suggests a specific warehouse move with load % before and after.",
                      "Use when planning stock reallocation or pre-positioning for new orders.",
                    ],
                    [
                      "Retrospective",
                      "Compares what actually happened vs what was projected. Flags wins, misses, under-supply gaps, and structural lessons.",
                      "Review at end of each reporting cycle. Feed lessons into next allocation decision.",
                    ],
                    [
                      "Forecast",
                      "Per-customer next-cycle projection based on linear trend, with confidence score. Total projected portfolio volume shown at top.",
                      "Use for capacity planning and pre-positioning stock before demand arrives.",
                    ],
                  ].map((r, i) => (
                    <tr key={i}>
                      <td
                        style={{
                          color: "var(--teal)",
                          fontWeight: 700,
                          fontFamily: "JetBrains Mono",
                          fontSize: 11,
                          whiteSpace: "nowrap",
                        }}
                      >
                        {r[0]}
                      </td>
                      <td>{r[1]}</td>
                      <td style={{ color: "var(--amber)" }}>{r[2]}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="tut-divider" />
              <div className="tut-section-label">Signal classifications</div>
              <div
                style={{
                  display: "flex",
                  flexWrap: "wrap",
                  gap: 8,
                  marginBottom: 14,
                }}
              >
                {[
                  {
                    label: "POSITIVE",
                    color: "var(--teal)",
                    bg: "rgba(6,214,160,.1)",
                    desc: "Growing trend detected",
                  },
                  {
                    label: "NEGATIVE",
                    color: "var(--coral)",
                    bg: "rgba(239,71,111,.1)",
                    desc: "Declining or anomalous drop",
                  },
                  {
                    label: "WARNING",
                    color: "var(--amber)",
                    bg: "rgba(255,209,102,.1)",
                    desc: "Concentration risk or volatility",
                  },
                  {
                    label: "NEUTRAL",
                    color: "var(--text2)",
                    bg: "rgba(136,153,187,.08)",
                    desc: "Stable, no strong trend",
                  },
                ].map((c, i) => (
                  <div
                    key={i}
                    style={{
                      background: c.bg,
                      border: `1px solid ${c.color}33`,
                      borderRadius: 9,
                      padding: "10px 14px",
                      minWidth: 160,
                    }}
                  >
                    <div
                      className="cls-badge"
                      style={{
                        color: c.color,
                        borderColor: `${c.color}44`,
                        background: `${c.color}15`,
                        marginBottom: 6,
                      }}
                    >
                      {c.label}
                    </div>
                    <div style={{ fontSize: 12, color: "var(--text2)" }}>
                      {c.desc}
                    </div>
                  </div>
                ))}
              </div>
              <div className="tut-section-label">
                Priority classifications (Recommendations)
              </div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                {[
                  {
                    label: "HIGH",
                    color: "var(--coral)",
                    desc: "Act within current cycle — holding cost, stockout risk, or concentration exceeding safe threshold",
                  },
                  {
                    label: "MEDIUM",
                    color: "var(--amber)",
                    desc: "Plan within 1–2 cycles — pre-positioning, resilience improvements, growing account management",
                  },
                  {
                    label: "LOW",
                    color: "var(--teal)",
                    desc: "Strategic improvements — utilisation, buffer policies, reporting frequency",
                  },
                ].map((c, i) => (
                  <div
                    key={i}
                    style={{
                      flex: "1 1 180px",
                      background: "var(--surface2)",
                      border: `1px solid ${c.color}33`,
                      borderLeft: `3px solid ${c.color}`,
                      borderRadius: 9,
                      padding: "12px 14px",
                    }}
                  >
                    <div
                      className="cls-badge"
                      style={{
                        color: c.color,
                        borderColor: `${c.color}44`,
                        background: `${c.color}15`,
                        marginBottom: 7,
                      }}
                    >
                      {c.label} PRIORITY
                    </div>
                    <div
                      style={{
                        fontSize: 12,
                        color: "var(--text2)",
                        lineHeight: 1.55,
                      }}
                    >
                      {c.desc}
                    </div>
                  </div>
                ))}
              </div>
            </>
          ),
        },
        {
          id: "drilldown",
          eyebrow: "Navigation — Drill-Down System",
          title: "3-Level Data Exploration",
          icon: "⤵",
          iconBg: "linear-gradient(135deg,#38bdf8,#06d6a0)",
          lead: "Every chart and table cell is a drill-down entry point. The system has 3 nested levels — each revealing a finer layer of granularity. You can always navigate back using the breadcrumb trail at the top.",
          content: () => (
            <>
              <div className="tut-section-label">The drill-down hierarchy</div>
              <div
                style={{
                  display: "flex",
                  flexDirection: "column",
                  gap: 6,
                  marginBottom: 20,
                }}
              >
                {[
                  {
                    level: "Level 0",
                    label: "Portfolio Overview",
                    icon: "◈",
                    color: "var(--teal)",
                    desc: "All warehouses, all customers, all periods. The default view for every tab.",
                    enter: "Any tab (default)",
                  },
                  {
                    level: "Level 1",
                    label: "Warehouse Detail",
                    icon: "▦",
                    color: "var(--amber)",
                    desc: "One warehouse's full customer list, trend chart, top customers bar chart, and stats. Click any warehouse bar, card, or tile.",
                    enter: "Click warehouse bar / card / tile",
                  },
                  {
                    level: "Level 2",
                    label: "Customer Detail",
                    icon: "◎",
                    color: "var(--sky)",
                    desc: "One customer's complete profile: multi-warehouse breakdown, stacked area chart over time, per-warehouse table with sparklines.",
                    enter: "Click customer name in any table or chart",
                  },
                  {
                    level: "Level 3",
                    label: "Customer × Warehouse",
                    icon: "⤵",
                    color: "var(--violet)",
                    desc: "The deepest level: one customer's stock in one specific warehouse, plotted over all periods. Shows exact unit trajectory.",
                    enter:
                      "Click a non-zero warehouse cell in data table, or warehouse row in customer detail",
                  },
                ].map((l, i) => (
                  <div
                    key={i}
                    style={{
                      display: "flex",
                      gap: 14,
                      alignItems: "flex-start",
                      padding: "12px 16px",
                      background: "var(--surface2)",
                      border: "1px solid var(--border)",
                      borderLeft: `3px solid ${l.color}`,
                      borderRadius: 10,
                    }}
                  >
                    <div style={{ width: 60, flexShrink: 0 }}>
                      <div
                        style={{
                          fontFamily: "JetBrains Mono",
                          fontSize: 9,
                          color: l.color,
                          fontWeight: 700,
                        }}
                      >
                        {l.level}
                      </div>
                      <div
                        style={{ fontSize: 18, marginTop: 2, color: l.color }}
                      >
                        {l.icon}
                      </div>
                    </div>
                    <div style={{ flex: 1 }}>
                      <div
                        style={{
                          fontSize: 13,
                          fontWeight: 700,
                          color: "var(--text)",
                          marginBottom: 3,
                        }}
                      >
                        {l.label}
                      </div>
                      <div
                        style={{
                          fontSize: 12,
                          color: "var(--text2)",
                          marginBottom: 5,
                        }}
                      >
                        {l.desc}
                      </div>
                      <div
                        style={{
                          fontFamily: "JetBrains Mono",
                          fontSize: 10,
                          color: l.color,
                        }}
                      >
                        Enter via: {l.enter}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="tut-section-label">Always find your way back</div>
              <div className="tut-steps">
                {[
                  {
                    title: "Breadcrumb trail (topbar)",
                    desc: "Shows your current location as a clickable path. Click any segment to jump back to that level instantly.",
                  },
                  {
                    title: "← Back button",
                    desc: "Available in every drill-down view. Returns you one level up.",
                  },
                  {
                    title: "Rail nav icons",
                    desc: "Clicking any tab icon from a drill-down state resets to Level 0 for that tab.",
                  },
                  {
                    title: "PE logo (top of rail)",
                    desc: "Always returns you to Overview Level 0.",
                  },
                ].map((s, i) => (
                  <div key={i} className="tut-step">
                    <div className="tut-step-num">{i + 1}</div>
                    <div className="tut-step-content">
                      <strong>{s.title}</strong> — {s.desc}
                    </div>
                  </div>
                ))}
              </div>
            </>
          ),
        },
        {
          id: "decisions",
          eyebrow: "Using the Platform",
          title: "Decisions You Can Make Better",
          icon: "✓",
          iconBg: "linear-gradient(135deg,#06d6a0,#ffd166)",
          lead: "This platform is designed to support operational and strategic stock decisions. Here's a guide to which view supports which decision — and what data points to look at.",
          content: () => (
            <>
              <div className="tut-section-label">Decision framework</div>
              <table className="tut-table" style={{ marginBottom: 16 }}>
                <thead>
                  <tr>
                    <th>Decision</th>
                    <th>Where to look</th>
                    <th>Key data point</th>
                  </tr>
                </thead>
                <tbody>
                  {[
                    [
                      "When to dispatch for a customer",
                      "Customer Detail → trend chart",
                      "Flat or rising trend = stock not moving. Escalate dispatch.",
                    ],
                    [
                      "Which warehouse is under pressure",
                      "Warehouses tab → Placement Optimizer",
                      "HHI > 0.35 or a warehouse tile showing > 30% share",
                    ],
                    [
                      "Which customers need pre-positioning",
                      "Intelligence → Forecast",
                      "Rising trend with R² > 0.6 and projected gap vs current stock",
                    ],
                    [
                      "Whether a large spike is normal",
                      "Intelligence → Signals (Anomaly)",
                      "Z-score > 1.8 flags unusual readings vs own history",
                    ],
                    [
                      "Where stock reallocation should happen",
                      "Intelligence → Placement Optimizer",
                      "Move arrows show which warehouse to move from and to",
                    ],
                    [
                      "Which accounts are highest priority",
                      "Intelligence → Signals (ABC class)",
                      "Class A customers = top 70% volume. Prioritise these",
                    ],
                    [
                      "Whether a trend is reliable",
                      "Any trend chart",
                      "R² confidence bar: > 70% reliable, < 40% treat with caution",
                    ],
                    [
                      "What went wrong last cycle",
                      "Intelligence → Retrospective",
                      "Misses and opportunity gaps tell you where supply fell short",
                    ],
                    [
                      "How concentrated your risk is",
                      "Overview → Hero strip + Intel HHI",
                      "HHI value in Executive Summary. Optimal is below 0.25",
                    ],
                    [
                      "Capacity planning for next cycle",
                      "Intelligence → Forecast",
                      "Projected total + per-customer delta tells you how much to allocate",
                    ],
                  ].map((r, i) => (
                    <tr key={i}>
                      <td style={{ color: "var(--text)", fontWeight: 600 }}>
                        {r[0]}
                      </td>
                      <td
                        style={{
                          color: "var(--teal)",
                          fontFamily: "JetBrains Mono",
                          fontSize: 11,
                        }}
                      >
                        {r[1]}
                      </td>
                      <td>{r[2]}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="tut-tip">
                <div className="tut-tip-icon">📋</div>
                <div className="tut-tip-text">
                  <strong>Weekly workflow suggestion:</strong> Open Overview →
                  check hero delta. Go to Intelligence → read Executive Summary.
                  Check HIGH priority actions. Open Retrospective for last cycle
                  lessons. Use Forecast to confirm allocations for next cycle.
                  Export from Data Table for distribution.
                </div>
              </div>
            </>
          ),
        },
      ];

      function TutorialModal({ onClose }) {
        const [step, setStep] = useState(0);
        const total = TUTORIAL_STEPS.length;
        const current = TUTORIAL_STEPS[step];
        const progress = ((step + 1) / total) * 100;

        const next = () => {
          if (step < total - 1) setStep((s) => s + 1);
          else onClose();
        };
        const prev = () => {
          if (step > 0) setStep((s) => s - 1);
        };

        // Close on Escape
        useEffect(() => {
          const h = (e) => {
            if (e.key === "Escape") onClose();
          };
          window.addEventListener("keydown", h);
          return () => window.removeEventListener("keydown", h);
        }, [onClose]);

        return (
          <div
            className="tut-overlay"
            onClick={(e) => {
              if (e.target === e.currentTarget) onClose();
            }}
          >
            <div className="tut-shell">
              {/* Progress */}
              <div className="tut-progress-rail">
                <div
                  className="tut-progress-fill"
                  style={{ width: `${progress}%` }}
                />
              </div>

              {/* Header */}
              <div className="tut-header">
                <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                  <div className="tut-step-badge">
                    <span>
                      {step + 1} / {total}
                    </span>
                    <span style={{ opacity: 0.6 }}>·</span>
                    <span
                      style={{
                        opacity: 0.8,
                        fontWeight: 400,
                        letterSpacing: 0,
                      }}
                    >
                      {current.eyebrow}
                    </span>
                  </div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                  <div className="tut-dots">
                    {TUTORIAL_STEPS.map((_, i) => (
                      <div
                        key={i}
                        className={`tut-dot${i === step ? " on" : ""}`}
                        onClick={() => setStep(i)}
                      />
                    ))}
                  </div>
                  <div className="tut-close" onClick={onClose}>
                    ×
                  </div>
                </div>
              </div>

              {/* Body */}
              <div className="tut-body">
                <div className="tut-chapter">
                  {/* Icon + title */}
                  <div
                    style={{
                      display: "flex",
                      alignItems: "flex-start",
                      gap: 18,
                      marginBottom: 20,
                      flexWrap: "wrap",
                    }}
                  >
                    <div
                      className="tut-icon"
                      style={{ background: current.iconBg }}
                    >
                      <span style={{ color: "#000", fontWeight: 700 }}>
                        {current.icon}
                      </span>
                    </div>
                    <div style={{ flex: 1, minWidth: 200 }}>
                      <div className="tut-eyebrow">{current.eyebrow}</div>
                      <div className="tut-title">{current.title}</div>
                      <div className="tut-lead">{current.lead}</div>
                    </div>
                  </div>
                  {/* Dynamic content */}
                  {current.content()}
                </div>
              </div>

              {/* Footer */}
              <div className="tut-footer">
                <span className="tut-btn-skip" onClick={onClose}>
                  Skip tutorial
                </span>
                <div className="tut-nav-btns">
                  {step > 0 && (
                    <button className="tut-btn tut-btn-ghost" onClick={prev}>
                      ← Previous
                    </button>
                  )}
                  <button className="tut-btn tut-btn-primary" onClick={next}>
                    {step < total - 1 ? <>Next →</> : <>Done ✓</>}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ═══════════════════════════════════════════════════════════════
      // MAIN APP
      // ═══════════════════════════════════════════════════════════════
      function App() {
        const [showTutorial, setShowTutorial] = useState(false);
        const [theme, setTheme] = useState("dark");
        const toggleTheme = useCallback(() => {
          setTheme((t) => {
            const next = t === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", next);
            return next;
          });
        }, []);

        const [tab, setTab] = useState("overview");
        const {
          reports,
          loading,
          error,
          isFallback,
          newBadge,
          lastFetch,
          reload,
        } = useReports();
        const [selectedReportId, setSelectedReportId] = useState(null);
        const [hiddenCustomers, setHiddenCustomers] = useState(new Set());
        const [searchQ, setSearchQ] = useState("");
        const [sortCol, setSortCol] = useState("grandTotal");
        const [sortDir, setSortDir] = useState("desc");
        const [selectedWH, setSelectedWH] = useState("grandTotal");
        const [showExport, setShowExport] = useState(false);
        const exportRef = useRef(null);
        const [drill, setDrill] = useState({ level: 0 });

        // Auto-select the latest report whenever data loads or a new report arrives
        useEffect(() => {
          if (reports.length > 0) {
            setSelectedReportId((id) => {
              const stillExists = reports.find((r) => r._id === id);
              return stillExists ? id : reports[reports.length - 1]._id;
            });
          }
        }, [reports]);

        const report = useMemo(() => {
          if (!reports.length) return null;
          return (
            reports.find((r) => r._id === selectedReportId) ||
            reports[reports.length - 1]
          );
        }, [reports, selectedReportId]);

        const allRows = useMemo(() => {
          if (!report) return [];
          const seen = new Set();
          return report.rows.filter((r) => {
            const k = `${r.customerName}__${r.wp}`;
            if (seen.has(k)) return false;
            seen.add(k);
            return true;
          });
        }, [report]);

        const filteredRows = useMemo(() => {
          if (!report) return [];
          let rows = report.rows.filter(
            (r) => !hiddenCustomers.has(`${r.customerName}__${r.wp}`)
          );
          if (searchQ)
            rows = rows.filter((r) =>
              r.customerName.toLowerCase().includes(searchQ.toLowerCase())
            );
          return [...rows].sort((a, b) => {
            let av = a[sortCol] ?? 0,
              bv = b[sortCol] ?? 0;
            if (typeof av === "string") {
              av = av.toLowerCase();
              bv = (bv || "").toLowerCase();
            }
            return sortDir === "asc" ? (av > bv ? 1 : -1) : av < bv ? 1 : -1;
          });
        }, [report, hiddenCustomers, searchQ, sortCol, sortDir]);

        const toggleSort = (col) => {
          if (sortCol === col)
            setSortDir((d) => (d === "asc" ? "desc" : "asc"));
          else {
            setSortCol(col);
            setSortDir("desc");
          }
        };

        const latest = reports[reports.length - 1];
        const prev = reports[reports.length - 2];
        const totalDelta = report
          ? (latest?.grandTotals.overall || 0) -
            (prev?.grandTotals.overall || 0)
          : 0;
        const topCustomer = report
          ? [...report.rows].sort((a, b) => b.grandTotal - a.grandTotal)[0]
          : null;
        const topWH = report
          ? WAREHOUSES.map((w) => ({
              ...w,
              v: report.grandTotals?.[w.key] || 0,
            })).sort((a, b) => b.v - a.v)[0]
          : null;

        const tsTotals = reports.map((r) => ({
          date: r.reportDateStr,
          Total: r.grandTotals?.overall || 0,
          ...Object.fromEntries(
            WAREHOUSES.map((w) => [w.label, r.grandTotals?.[w.key] || 0])
          ),
        }));

        const custLines = useMemo(() => {
          if (!report) return { keys: [], data: [] };
          const top8 = allRows
            .filter((r) => !hiddenCustomers.has(`${r.customerName}__${r.wp}`))
            .slice(0, 8);
          return {
            keys: top8.map((r) => r.customerName),
            data: reports.map((rep) => ({
              date: rep.reportDateStr,
              ...Object.fromEntries(
                top8.map((ck) => {
                  const found = rep.rows.find(
                    (r) => r.customerName === ck.customerName && r.wp === ck.wp
                  );
                  return [
                    ck.customerName,
                    found?.[
                      selectedWH === "grandTotal" ? "grandTotal" : selectedWH
                    ] || 0,
                  ];
                })
              ),
            })),
          };
        }, [reports, allRows, hiddenCustomers, selectedWH, report]);

        const pieData = report
          ? WAREHOUSES.map((w) => ({
              name: w.label,
              value: report.grandTotals?.[w.key] || 0,
            })).filter((d) => d.value > 0)
          : [];

        useEffect(() => {
          const h = (e) => {
            if (exportRef.current && !exportRef.current.contains(e.target))
              setShowExport(false);
          };
          document.addEventListener("mousedown", h);
          return () => document.removeEventListener("mousedown", h);
        }, []);

        const drillWarehouse = (wh) => setDrill({ level: 1, type: "wh", wh });
        const drillCustomer = (customer) =>
          setDrill({ level: 2, type: "cust", customer });
        const drillCxW = (customer, wh) =>
          setDrill({ level: 3, type: "cxw", customer, wh });
        const backToOverview = () => setDrill({ level: 0 });
        const backToCustomer = () =>
          setDrill((d) => ({ level: 2, type: "cust", customer: d.customer }));

        const animatedTotal = useCountUp(report?.grandTotals?.overall || 0);
        const animatedDelta = useCountUp(Math.abs(totalDelta));

        const NAV = [
          { id: "overview", icon: "◈", tip: "Overview" },
          { id: "trends", icon: "◎", tip: "Trends" },
          { id: "warehouses", icon: "▦", tip: "Warehouses" },
          { id: "data", icon: "≡", tip: "Data Table" },
          { id: "intel", icon: "◆", tip: "Intelligence" },
        ];

        // Breadcrumb
        const Breadcrumbs = () => (
          <div className="topbar-breadcrumb">
            <span className="bc-seg" onClick={backToOverview}>
              PE · Stock
            </span>
            {drill.level === 0 && (
              <>
                <span className="bc-arrow">›</span>
                <span className="bc-active">
                  {NAV.find((n) => n.id === tab)?.tip || tab}
                </span>
              </>
            )}
            {drill.level >= 1 && drill.type === "wh" && (
              <>
                <span className="bc-arrow">›</span>
                <span className="bc-active">{drill.wh.label} Warehouse</span>
              </>
            )}
            {drill.level >= 2 && drill.type === "cust" && (
              <>
                <span className="bc-arrow">›</span>
                <span className="bc-active">{drill.customer.customerName}</span>
              </>
            )}
            {drill.level === 3 && (
              <>
                <span className="bc-arrow">›</span>
                <span className="bc-active">{drill.wh.label}</span>
              </>
            )}
          </div>
        );

        const handleWhBarClick = (data) => {
          if (!data?.activePayload?.[0] || !report) return;
          const label = data.activePayload[0].payload.name;
          const wh = WAREHOUSES.find((w) => w.label === label);
          if (wh) drillWarehouse(wh);
        };
        const handleCustBarClick = (data) => {
          if (!data?.activePayload?.[0] || !report) return;
          const name = data.activePayload[0].payload.name;
          const row = report.rows.find((r) =>
            r.customerName.startsWith(name.replace("…", "").trim())
          );
          if (row) drillCustomer(row);
        };

        return (
          <div className="shell">
            {showTutorial && (
              <TutorialModal onClose={() => setShowTutorial(false)} />
            )}

            {/* ── FULL-SCREEN LOADING ──────────────────────────── */}
            {loading && (
              <div
                style={{
                  position: "fixed",
                  inset: 0,
                  zIndex: 9999,
                  background: "var(--bg)",
                  display: "flex",
                  flexDirection: "column",
                  alignItems: "center",
                  justifyContent: "center",
                  gap: 20,
                }}
              >
                <div
                  style={{
                    width: 48,
                    height: 48,
                    borderRadius: 14,
                    background:
                      "linear-gradient(135deg,var(--teal),var(--sky))",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    fontFamily: "Syne,sans-serif",
                    fontWeight: 800,
                    fontSize: 16,
                    color: "#000",
                    animation: "glow 2s ease infinite",
                  }}
                >
                  PE
                </div>
                <div
                  style={{
                    fontFamily: "JetBrains Mono,monospace",
                    fontSize: 12,
                    color: "var(--muted)",
                  }}
                >
                  Loading reports from database…
                </div>
                <div
                  style={{
                    width: 200,
                    height: 2,
                    background: "var(--faint)",
                    borderRadius: 2,
                    overflow: "hidden",
                  }}
                >
                  <div
                    style={{
                      height: "100%",
                      background:
                        "linear-gradient(90deg,var(--teal),var(--sky))",
                      borderRadius: 2,
                      animation: "loadBar 1.4s ease infinite",
                    }}
                  />
                </div>
                <style>{`@keyframes loadBar{0%{width:0%;margin-left:0}60%{width:100%;margin-left:0}100%{width:0%;margin-left:100%}}`}</style>
              </div>
            )}

            {/* RAIL */}
            <nav className="rail">
              <div
                className="rail-logo"
                onClick={() => {
                  setTab("overview");
                  backToOverview();
                }}
                title="PE Signal Room"
              >
                PE
              </div>
              {NAV.map((n) => (
                <div
                  key={n.id}
                  className={`rail-btn${
                    tab === n.id && drill.level === 0 ? " active" : ""
                  }`}
                  data-tip={n.tip}
                  onClick={() => {
                    setTab(n.id);
                    if (drill.level !== 0) backToOverview();
                  }}
                  style={{ fontSize: 18 }}
                >
                  {n.icon}
                </div>
              ))}
              <div className="rail-divider" />
              <div className="rail-spacer" />
              <div
                className="rail-tut tut-pulse"
                onClick={() => setShowTutorial(true)}
                title="Open Tutorial"
              >
                ?
              </div>
              <div style={{ height: 6 }} />
              <div
                className="rail-theme"
                onClick={toggleTheme}
                title="Toggle theme"
              >
                {theme === "dark" ? "☀" : "🌙"}
              </div>
            </nav>

            {/* MAIN CANVAS */}
            <div className="canvas">
              {/* TOPBAR */}
              <div className="topbar">
                <Breadcrumbs />
                <div className="topbar-right">
                  <div className="live-pill">
                    <div className="live-dot" />
                    LIVE
                  </div>

                  {/* New report badge */}
                  {newBadge && (
                    <div
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: 6,
                        background: "rgba(6,214,160,.15)",
                        border: "1px solid var(--teal)",
                        borderRadius: 20,
                        padding: "4px 12px",
                        fontFamily: "JetBrains Mono,monospace",
                        fontSize: 11,
                        color: "var(--teal)",
                        animation: "fadeIn .3s ease",
                      }}
                    >
                      ⬆ New report loaded
                    </div>
                  )}

                  {/* Fallback / demo banner */}
                  {isFallback && (
                    <div
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: 6,
                        background: "rgba(255,209,102,.10)",
                        border: "1px solid rgba(255,209,102,.35)",
                        borderRadius: 8,
                        padding: "4px 12px",
                        fontFamily: "JetBrains Mono,monospace",
                        fontSize: 10,
                        color: "var(--amber)",
                        cursor: "pointer",
                      }}
                      onClick={() => reload()}
                      title={
                        error
                          ? `API error: ${error}`
                          : "No reports in database yet"
                      }
                    >
                      {error
                        ? "⚠ API unreachable — showing demo data · click to retry"
                        : "◎ No DB reports yet — showing demo data"}
                    </div>
                  )}

                  {/* Last fetch time */}
                  {lastFetch && !isFallback && (
                    <div
                      style={{
                        fontFamily: "JetBrains Mono,monospace",
                        fontSize: 10,
                        color: "var(--muted)",
                        cursor: "pointer",
                      }}
                      onClick={() => reload()}
                      title="Click to refresh now"
                    >
                      ↺ {lastFetch.toLocaleTimeString()}
                    </div>
                  )}
                  <div className="report-selector">
                    {reports.map((r) => (
                      <div
                        key={r._id}
                        className={`rsel${
                          selectedReportId === r._id ? " active" : ""
                        }`}
                        onClick={() => setSelectedReportId(r._id)}
                      >
                        {r.reportDateStr}
                      </div>
                    ))}
                  </div>
                  <div className="export-wrap" ref={exportRef}>
                    <button
                      className="btn btn-ghost btn-sm"
                      onClick={() => setShowExport((e) => !e)}
                    >
                      ⬇ Export
                    </button>
                    {showExport && (
                      <div className="export-menu">
                        <div
                          className="export-item"
                          onClick={() => {
                            dlCSV(
                              filteredRows,
                              `stock_${report.reportDateStr}.csv`
                            );
                            setShowExport(false);
                          }}
                        >
                          📄 CSV — Current View
                        </div>
                        <div
                          className="export-item"
                          onClick={() => {
                            dlJSON(
                              report,
                              `report_${report.reportDateStr}.json`
                            );
                            setShowExport(false);
                          }}
                        >
                          📦 JSON — Full Report
                        </div>
                        <div
                          className="export-item"
                          onClick={() => {
                            dlJSON(reports, `all_reports.json`);
                            setShowExport(false);
                          }}
                        >
                          📦 JSON — All Reports
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* CONTENT */}
              <div className="content">
                {/* ─── NULL GUARD (data loading / empty) ───────────────────── */}
                {!report && !loading && (
                  <div
                    style={{
                      flex: 1,
                      display: "flex",
                      flexDirection: "column",
                      alignItems: "center",
                      justifyContent: "center",
                      gap: 16,
                      padding: 60,
                      textAlign: "center",
                    }}
                  >
                    <div style={{ fontSize: 40 }}>📭</div>
                    <div
                      style={{
                        fontFamily: "Syne,sans-serif",
                        fontSize: 20,
                        fontWeight: 800,
                        color: "var(--text)",
                      }}
                    >
                      No reports found
                    </div>
                    <div
                      style={{
                        fontSize: 13,
                        color: "var(--muted)",
                        maxWidth: 380,
                        lineHeight: 1.7,
                      }}
                    >
                      The database is empty. Run a backfill to seed historical
                      reports, or wait for the next email poll to capture a new
                      one.
                    </div>
                    <div
                      style={{
                        fontFamily: "JetBrains Mono,monospace",
                        fontSize: 11,
                        background: "var(--surface)",
                        border: "1px solid var(--border)",
                        borderRadius: 8,
                        padding: "8px 16px",
                        color: "var(--muted)",
                      }}
                    >
                      node server.js --backfill 10
                    </div>
                    <button className="btn btn-teal" onClick={() => reload()}>
                      ↺ Retry
                    </button>
                  </div>
                )}

                {/* ─── DRILLDOWN VIEWS ─────────────────────────────── */}
                {report && (
                  <>
                    {drill.level === 1 && drill.type === "wh" && (
                      <WarehouseDetail
                        wh={drill.wh}
                        reports={reports}
                        report={report}
                        onBack={backToOverview}
                        onCustomerDrill={drillCustomer}
                      />
                    )}
                    {drill.level === 2 && drill.type === "cust" && (
                      <CustomerDetail
                        customer={drill.customer}
                        reports={reports}
                        report={report}
                        onBack={backToOverview}
                        onWhDrill={(wh) => drillCxW(drill.customer, wh)}
                      />
                    )}
                    {drill.level === 3 && drill.type === "cxw" && (
                      <CxWDetail
                        customer={drill.customer}
                        wh={drill.wh}
                        reports={reports}
                        report={report}
                        onBack={backToOverview}
                        onBackToCustomer={backToCustomer}
                      />
                    )}

                    {drill.level === 0 && (
                      <>
                        {/* ═══════════════════════════════════════════════════
              OVERVIEW TAB
          ═══════════════════════════════════════════════════ */}
                        {tab === "overview" && (
                          <>
                            {/* HERO */}
                            <div className="hero fade-up">
                              <div className="hero-grid">
                                <div className="hero-main">
                                  <div className="hero-label">
                                    Total Stock Units
                                  </div>
                                  <div className="hero-value">
                                    {fmt(animatedTotal)}
                                    <span className="hero-unit">units</span>
                                  </div>
                                  <div
                                    className={`hero-delta ${
                                      totalDelta >= 0 ? "up" : "down"
                                    }`}
                                  >
                                    {totalDelta >= 0 ? "▲" : "▼"}{" "}
                                    {fmt(animatedDelta)} vs prev period
                                    {prev && (
                                      <span
                                        style={{ marginLeft: 8, opacity: 0.6 }}
                                      >
                                        (
                                        {prev
                                          ? (
                                              (totalDelta /
                                                (prev.grandTotals.overall ||
                                                  1)) *
                                              100
                                            ).toFixed(1)
                                          : "—"}
                                        %)
                                      </span>
                                    )}
                                  </div>
                                </div>
                                <div className="hero-stat">
                                  <div className="hero-label">Top Customer</div>
                                  <div
                                    className="hero-value"
                                    style={{
                                      fontSize: 20,
                                      color: "var(--teal)",
                                    }}
                                  >
                                    {topCustomer?.customerName || "—"}
                                  </div>
                                  <div
                                    className="hero-label"
                                    style={{ marginTop: 4 }}
                                  >
                                    {fmt(topCustomer?.grandTotal)} units
                                  </div>
                                </div>
                                <div className="hero-stat">
                                  <div className="hero-label">
                                    Top Warehouse
                                  </div>
                                  <div
                                    className="hero-value"
                                    style={{
                                      fontSize: 20,
                                      color: "var(--amber)",
                                    }}
                                  >
                                    {topWH?.label || "—"}
                                  </div>
                                  <div
                                    className="hero-label"
                                    style={{ marginTop: 4 }}
                                  >
                                    {pct(
                                      topWH?.v || 0,
                                      report.grandTotals?.overall || 1
                                    )}{" "}
                                    of total
                                  </div>
                                </div>
                                <div className="hero-stat">
                                  <div className="hero-label">
                                    Active Customers
                                  </div>
                                  <div
                                    className="hero-value"
                                    style={{ fontSize: 28 }}
                                  >
                                    {
                                      report.rows.filter(
                                        (r) => r.grandTotal > 0
                                      ).length
                                    }
                                  </div>
                                  <div
                                    className="hero-label"
                                    style={{ marginTop: 4 }}
                                  >
                                    across{" "}
                                    {
                                      WAREHOUSES.filter(
                                        (w) =>
                                          (report.grandTotals?.[w.key] || 0) > 0
                                      ).length
                                    }{" "}
                                    warehouses
                                  </div>
                                </div>
                              </div>
                            </div>

                            {/* WAREHOUSE DISTRIBUTION + CUSTOMER BAR */}
                            <div className="two-col">
                              <div className="panel fade-up a2">
                                <div className="panel-head">
                                  <span className="panel-title">
                                    <span
                                      className="panel-title-dot"
                                      style={{ background: "var(--amber)" }}
                                    />{" "}
                                    Warehouse Distribution
                                  </span>
                                  <span
                                    style={{
                                      fontSize: 10,
                                      fontFamily: "JetBrains Mono",
                                      color: "var(--muted)",
                                    }}
                                  >
                                    Click to drill
                                  </span>
                                </div>
                                <div className="panel-body">
                                  <ResponsiveContainer
                                    width="100%"
                                    height={200}
                                  >
                                    <BarChart
                                      data={WAREHOUSES.map((w) => ({
                                        name: w.label,
                                        value: report.grandTotals?.[w.key] || 0,
                                      }))}
                                      onClick={handleWhBarClick}
                                      style={{ cursor: "pointer" }}
                                    >
                                      <CartesianGrid
                                        strokeDasharray="3 3"
                                        stroke="var(--border)"
                                        vertical={false}
                                      />
                                      <XAxis
                                        dataKey="name"
                                        tick={{
                                          fill: "var(--muted)",
                                          fontSize: 9,
                                          fontFamily: "JetBrains Mono",
                                        }}
                                        axisLine={false}
                                        tickLine={false}
                                      />
                                      <YAxis hide />
                                      <Tooltip content={<TT />} />
                                      <Bar
                                        dataKey="value"
                                        name="Units"
                                        radius={[4, 4, 0, 0]}
                                      >
                                        {WAREHOUSES.map((_, i) => (
                                          <Cell key={i} fill={P[i]} />
                                        ))}
                                      </Bar>
                                    </BarChart>
                                  </ResponsiveContainer>
                                </div>
                              </div>
                              <div className="panel fade-up a3">
                                <div className="panel-head">
                                  <span className="panel-title">
                                    <span
                                      className="panel-title-dot"
                                      style={{ background: "var(--teal)" }}
                                    />{" "}
                                    Top 10 Customers
                                  </span>
                                  <span
                                    style={{
                                      fontSize: 10,
                                      fontFamily: "JetBrains Mono",
                                      color: "var(--muted)",
                                    }}
                                  >
                                    Click to drill
                                  </span>
                                </div>
                                <div className="panel-body">
                                  <ResponsiveContainer
                                    width="100%"
                                    height={200}
                                  >
                                    <BarChart
                                      layout="vertical"
                                      data={[...report.rows]
                                        .sort(
                                          (a, b) => b.grandTotal - a.grandTotal
                                        )
                                        .slice(0, 10)
                                        .map((r) => ({
                                          name:
                                            r.customerName.length > 18
                                              ? r.customerName.slice(0, 18) +
                                                "…"
                                              : r.customerName,
                                          value: r.grandTotal,
                                          _row: r,
                                        }))}
                                      onClick={(d) => {
                                        if (d?.activePayload?.[0]) {
                                          const row =
                                            d.activePayload[0].payload._row;
                                          if (row) drillCustomer(row);
                                        }
                                      }}
                                    >
                                      <CartesianGrid
                                        strokeDasharray="3 3"
                                        stroke="var(--border)"
                                        horizontal={false}
                                      />
                                      <XAxis type="number" hide />
                                      <YAxis
                                        type="category"
                                        dataKey="name"
                                        tick={{
                                          fill: "var(--muted)",
                                          fontSize: 9,
                                          fontFamily: "JetBrains Mono",
                                        }}
                                        axisLine={false}
                                        tickLine={false}
                                        width={120}
                                      />
                                      <Tooltip content={<TT />} />
                                      <Bar
                                        dataKey="value"
                                        name="Units"
                                        radius={[0, 4, 4, 0]}
                                        style={{ cursor: "pointer" }}
                                      >
                                        {[...Array(10)].map((_, i) => (
                                          <Cell key={i} fill={P[i]} />
                                        ))}
                                      </Bar>
                                    </BarChart>
                                  </ResponsiveContainer>
                                </div>
                              </div>
                            </div>

                            {/* PORTFOLIO TREND */}
                            <div className="panel fade-up a4">
                              <div className="panel-head">
                                <span className="panel-title">
                                  <span
                                    className="panel-title-dot"
                                    style={{ background: "var(--sky)" }}
                                  />{" "}
                                  Portfolio Stock Trend
                                </span>
                              </div>
                              <div className="panel-body">
                                <ResponsiveContainer width="100%" height={180}>
                                  <AreaChart data={tsTotals}>
                                    <defs>
                                      <linearGradient
                                        id="totDg"
                                        x1="0"
                                        y1="0"
                                        x2="0"
                                        y2="1"
                                      >
                                        <stop
                                          offset="5%"
                                          stopColor="var(--sky)"
                                          stopOpacity={0.3}
                                        />
                                        <stop
                                          offset="95%"
                                          stopColor="var(--sky)"
                                          stopOpacity={0}
                                        />
                                      </linearGradient>
                                    </defs>
                                    <CartesianGrid
                                      strokeDasharray="3 3"
                                      stroke="var(--border)"
                                      vertical={false}
                                    />
                                    <XAxis
                                      dataKey="date"
                                      tick={{
                                        fill: "var(--muted)",
                                        fontSize: 9,
                                        fontFamily: "JetBrains Mono",
                                      }}
                                      axisLine={false}
                                      tickLine={false}
                                    />
                                    <YAxis hide />
                                    <Tooltip content={<TT />} />
                                    <Area
                                      type="monotone"
                                      dataKey="Total"
                                      stroke="var(--sky)"
                                      strokeWidth={2.5}
                                      fill="url(#totDg)"
                                      dot={false}
                                    />
                                  </AreaChart>
                                </ResponsiveContainer>
                              </div>
                            </div>

                            {/* KPI CARDS */}
                            <div className="card-grid">
                              {WAREHOUSES.map((wh, i) => {
                                const v = report.grandTotals?.[wh.key] || 0;
                                const pv2 = prev?.grandTotals?.[wh.key] || 0;
                                const d2 = v - pv2;
                                const dp =
                                  pv2 > 0
                                    ? ((d2 / pv2) * 100).toFixed(1)
                                    : null;
                                return (
                                  <div
                                    key={wh.key}
                                    className="card clickable fade-up"
                                    style={{ animationDelay: `${i * 0.04}s` }}
                                    onClick={() => drillWarehouse(wh)}
                                  >
                                    <div
                                      className="card-accent"
                                      style={{ background: P[i] }}
                                    />
                                    <div className="card-label">{wh.label}</div>
                                    <div
                                      className="card-value"
                                      style={{ color: P[i] }}
                                    >
                                      {fmt(v)}
                                    </div>
                                    <div className="card-sub">
                                      {dp !== null && (
                                        <span
                                          style={{
                                            color:
                                              d2 >= 0
                                                ? "var(--teal)"
                                                : "var(--coral)",
                                            fontFamily: "JetBrains Mono",
                                            fontSize: 11,
                                          }}
                                        >
                                          {d2 >= 0 ? "+" : ""}
                                          {dp}%{" "}
                                        </span>
                                      )}
                                      {pct(v, report.grandTotals?.overall || 1)}{" "}
                                      of total
                                    </div>
                                    <div className="card-badge">drill ›</div>
                                  </div>
                                );
                              })}
                            </div>
                          </>
                        )}

                        {/* ═══════════════════════════════════════════════════
              TRENDS TAB
          ═══════════════════════════════════════════════════ */}
                        {tab === "trends" && (
                          <>
                            <div className="panel fade-up">
                              <div className="panel-head">
                                <span className="panel-title">
                                  <span
                                    className="panel-title-dot"
                                    style={{ background: "var(--sky)" }}
                                  />{" "}
                                  Warehouse Stock Over Time
                                </span>
                              </div>
                              <div className="panel-body">
                                <ResponsiveContainer width="100%" height={260}>
                                  <LineChart data={tsTotals}>
                                    <CartesianGrid
                                      strokeDasharray="3 3"
                                      stroke="var(--border)"
                                      vertical={false}
                                    />
                                    <XAxis
                                      dataKey="date"
                                      tick={{
                                        fill: "var(--muted)",
                                        fontSize: 9,
                                        fontFamily: "JetBrains Mono",
                                      }}
                                      axisLine={false}
                                      tickLine={false}
                                    />
                                    <YAxis hide />
                                    <Tooltip content={<TT />} />
                                    <Legend
                                      wrapperStyle={{
                                        fontSize: 10,
                                        fontFamily: "JetBrains Mono",
                                      }}
                                    />
                                    {WAREHOUSES.map((w, i) => (
                                      <Line
                                        key={w.key}
                                        type="monotone"
                                        dataKey={w.label}
                                        stroke={P[i]}
                                        strokeWidth={2}
                                        dot={false}
                                        activeDot={{ r: 5 }}
                                      />
                                    ))}
                                  </LineChart>
                                </ResponsiveContainer>
                              </div>
                            </div>
                            <div className="panel fade-up a2">
                              <div className="panel-head">
                                <span className="panel-title">
                                  <span
                                    className="panel-title-dot"
                                    style={{ background: "var(--teal)" }}
                                  />{" "}
                                  Customer Stock Trends
                                </span>
                                <div
                                  style={{
                                    display: "flex",
                                    gap: 6,
                                    flexWrap: "wrap",
                                  }}
                                >
                                  <div className="wh-pills">
                                    {[
                                      { key: "grandTotal", label: "Total" },
                                      ...WAREHOUSES,
                                    ].map((w) => (
                                      <div
                                        key={w.key}
                                        className={`wh-pill${
                                          selectedWH === w.key ? " on" : ""
                                        }`}
                                        onClick={() => setSelectedWH(w.key)}
                                      >
                                        {w.label || w.short}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              </div>
                              <div className="panel-body">
                                <ResponsiveContainer width="100%" height={240}>
                                  <LineChart data={custLines.data}>
                                    <CartesianGrid
                                      strokeDasharray="3 3"
                                      stroke="var(--border)"
                                      vertical={false}
                                    />
                                    <XAxis
                                      dataKey="date"
                                      tick={{
                                        fill: "var(--muted)",
                                        fontSize: 9,
                                        fontFamily: "JetBrains Mono",
                                      }}
                                      axisLine={false}
                                      tickLine={false}
                                    />
                                    <YAxis hide />
                                    <Tooltip content={<TT />} />
                                    <Legend
                                      wrapperStyle={{
                                        fontSize: 10,
                                        fontFamily: "JetBrains Mono",
                                      }}
                                    />
                                    {custLines.keys.map((k, i) => (
                                      <Line
                                        key={k}
                                        type="monotone"
                                        dataKey={k}
                                        stroke={P[i]}
                                        strokeWidth={2}
                                        dot={false}
                                        activeDot={{ r: 4 }}
                                      />
                                    ))}
                                  </LineChart>
                                </ResponsiveContainer>
                              </div>
                            </div>
                            <div className="panel fade-up a3">
                              <div className="panel-head">
                                <span className="panel-title">
                                  <span
                                    className="panel-title-dot"
                                    style={{ background: "var(--amber)" }}
                                  />{" "}
                                  Warehouse Share — Stacked Area
                                </span>
                              </div>
                              <div className="panel-body">
                                <ResponsiveContainer width="100%" height={200}>
                                  <AreaChart data={tsTotals}>
                                    <CartesianGrid
                                      strokeDasharray="3 3"
                                      stroke="var(--border)"
                                      vertical={false}
                                    />
                                    <XAxis
                                      dataKey="date"
                                      tick={{
                                        fill: "var(--muted)",
                                        fontSize: 9,
                                        fontFamily: "JetBrains Mono",
                                      }}
                                      axisLine={false}
                                      tickLine={false}
                                    />
                                    <YAxis hide />
                                    <Tooltip content={<TT />} />
                                    <Legend
                                      wrapperStyle={{
                                        fontSize: 10,
                                        fontFamily: "JetBrains Mono",
                                      }}
                                    />
                                    {WAREHOUSES.map((w, i) => (
                                      <Area
                                        key={w.key}
                                        type="monotone"
                                        dataKey={w.label}
                                        stackId="1"
                                        stroke={P[i]}
                                        fill={P[i] + "55"}
                                        strokeWidth={1.5}
                                        dot={false}
                                      />
                                    ))}
                                  </AreaChart>
                                </ResponsiveContainer>
                              </div>
                            </div>
                          </>
                        )}

                        {/* ═══════════════════════════════════════════════════
              WAREHOUSES TAB
          ═══════════════════════════════════════════════════ */}
                        {tab === "warehouses" && (
                          <div className="fade-up">
                            <div className="wh-grid">
                              {WAREHOUSES.map((wh, wi) => {
                                const v = report.grandTotals?.[wh.key] || 0;
                                const pv2 = prev?.grandTotals?.[wh.key] || 0;
                                const d2 = v - pv2;
                                const ts2 = reports.map(
                                  (r) => r.grandTotals?.[wh.key] || 0
                                );
                                const mx = Math.max(...ts2, 1);
                                const share =
                                  report.grandTotals?.overall > 0
                                    ? (
                                        (v / report.grandTotals.overall) *
                                        100
                                      ).toFixed(1)
                                    : "0";
                                const custCount = report.rows.filter(
                                  (r) => (r[wh.key] || 0) > 0
                                ).length;
                                return (
                                  <div
                                    key={wh.key}
                                    className="wh-tile fade-up"
                                    style={{ animationDelay: `${wi * 0.05}s` }}
                                    onClick={() => drillWarehouse(wh)}
                                  >
                                    <div
                                      className="wh-tile-bar"
                                      style={{ background: P[wi] }}
                                    />
                                    <div className="wh-tile-body">
                                      <div
                                        className="wh-tile-share"
                                        style={{ color: P[wi] }}
                                      >
                                        {share}%
                                      </div>
                                      <div
                                        className="wh-tile-name"
                                        style={{ color: P[wi] }}
                                      >
                                        {wh.label}
                                      </div>
                                      <div className="wh-tile-val">
                                        {fmt(v)}
                                      </div>
                                      <div
                                        style={{
                                          display: "flex",
                                          gap: 2,
                                          alignItems: "flex-end",
                                          marginBottom: 10,
                                          height: 32,
                                        }}
                                      >
                                        {ts2.map((tv, j) => {
                                          const bh = Math.max(
                                            3,
                                            Math.round((tv / mx) * 32)
                                          );
                                          const isLast = j === ts2.length - 1;
                                          return (
                                            <div
                                              key={j}
                                              style={{
                                                width: 6,
                                                height: bh,
                                                background: isLast
                                                  ? P[wi]
                                                  : P[wi] + "55",
                                                borderRadius: 2,
                                                transition: "height .3s",
                                              }}
                                            />
                                          );
                                        })}
                                      </div>
                                      <div className="wh-tile-meta">
                                        <span>{custCount} customers</span>
                                        <span
                                          style={{
                                            color:
                                              d2 >= 0
                                                ? "var(--teal)"
                                                : "var(--coral)",
                                            fontFamily: "JetBrains Mono",
                                            fontSize: 11,
                                          }}
                                        >
                                          {d2 >= 0 ? "+" : ""}
                                          {fmt(d2)}
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            {/* Pie chart */}
                            <div className="panel" style={{ marginTop: 16 }}>
                              <div className="panel-head">
                                <span className="panel-title">
                                  <span
                                    className="panel-title-dot"
                                    style={{ background: "var(--violet)" }}
                                  />{" "}
                                  Portfolio Split
                                </span>
                              </div>
                              <div className="panel-body">
                                <div
                                  style={{
                                    display: "flex",
                                    gap: 20,
                                    flexWrap: "wrap",
                                    alignItems: "center",
                                  }}
                                >
                                  <ResponsiveContainer width={220} height={220}>
                                    <PieChart>
                                      <Pie
                                        data={pieData}
                                        dataKey="value"
                                        cx="50%"
                                        cy="50%"
                                        innerRadius={55}
                                        outerRadius={90}
                                        paddingAngle={3}
                                      >
                                        {pieData.map((_, i) => (
                                          <Cell key={i} fill={P[i]} />
                                        ))}
                                      </Pie>
                                      <Tooltip content={<TT />} />
                                    </PieChart>
                                  </ResponsiveContainer>
                                  <div
                                    style={{
                                      flex: 1,
                                      display: "grid",
                                      gridTemplateColumns:
                                        "repeat(auto-fill,minmax(150px,1fr))",
                                      gap: 8,
                                    }}
                                  >
                                    {pieData.map((d, i) => (
                                      <div
                                        key={d.name}
                                        style={{
                                          display: "flex",
                                          alignItems: "center",
                                          gap: 8,
                                          cursor: "pointer",
                                        }}
                                        onClick={() => {
                                          const wh = WAREHOUSES.find(
                                            (w) => w.label === d.name
                                          );
                                          if (wh) drillWarehouse(wh);
                                        }}
                                      >
                                        <div
                                          style={{
                                            width: 10,
                                            height: 10,
                                            background: P[i],
                                            borderRadius: 3,
                                            flexShrink: 0,
                                          }}
                                        />
                                        <div>
                                          <div
                                            style={{
                                              fontSize: 12,
                                              fontWeight: 600,
                                              color: "var(--text)",
                                            }}
                                          >
                                            {d.name}
                                          </div>
                                          <div
                                            style={{
                                              fontFamily: "JetBrains Mono",
                                              fontSize: 10,
                                              color: "var(--muted)",
                                            }}
                                          >
                                            {fmt(d.value)}
                                          </div>
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* ═══════════════════════════════════════════════════
              DATA TABLE TAB
          ═══════════════════════════════════════════════════ */}
                        {tab === "data" && (
                          <div className="panel fade-up">
                            <div className="panel-head">
                              <span className="panel-title">
                                <span
                                  className="panel-title-dot"
                                  style={{ background: "var(--teal)" }}
                                />{" "}
                                Granular Data · {report.reportDateStr}
                              </span>
                              <div
                                style={{
                                  display: "flex",
                                  gap: 8,
                                  alignItems: "center",
                                  flexWrap: "wrap",
                                }}
                              >
                                <div className="search-box">
                                  <span className="search-icon">⌕</span>
                                  <input
                                    placeholder="Search customer…"
                                    value={searchQ}
                                    onChange={(e) => setSearchQ(e.target.value)}
                                  />
                                </div>
                                <button
                                  className="btn btn-ghost btn-sm"
                                  onClick={() =>
                                    dlCSV(
                                      filteredRows,
                                      `stock_${report.reportDateStr}.csv`
                                    )
                                  }
                                >
                                  ⬇ CSV
                                </button>
                              </div>
                            </div>
                            <div className="report-strip">
                              {reports.map((r) => (
                                <div
                                  key={r._id}
                                  className={`rchip${
                                    selectedReportId === r._id ? " on" : ""
                                  }`}
                                  onClick={() => setSelectedReportId(r._id)}
                                >
                                  {r.reportDateStr}
                                </div>
                              ))}
                            </div>
                            {/* Customer legend sidebar + table */}
                            <div style={{ display: "flex", gap: 0 }}>
                              <div
                                style={{
                                  width: 200,
                                  minWidth: 160,
                                  borderRight: "1px solid var(--border)",
                                  padding: "12px 10px",
                                  overflowY: "auto",
                                  maxHeight: "calc(100vh - 280px)",
                                }}
                              >
                                <div
                                  style={{
                                    fontFamily: "JetBrains Mono",
                                    fontSize: 9,
                                    color: "var(--muted)",
                                    textTransform: "uppercase",
                                    letterSpacing: ".09em",
                                    marginBottom: 8,
                                  }}
                                >
                                  Customers
                                </div>
                                {allRows.map((r, i) => {
                                  const k = `${r.customerName}__${r.wp}`;
                                  const hidden = hiddenCustomers.has(k);
                                  return (
                                    <div
                                      key={k}
                                      className={`cust-chip${
                                        hidden ? " off" : ""
                                      }`}
                                      onClick={() =>
                                        setHiddenCustomers((h) => {
                                          const n = new Set(h);
                                          n.has(k) ? n.delete(k) : n.add(k);
                                          return n;
                                        })
                                      }
                                    >
                                      <div
                                        className="chip-dot"
                                        style={{ background: P[i % P.length] }}
                                      />
                                      <span className="chip-name">
                                        {r.customerName}
                                      </span>
                                      <span className="chip-val">
                                        {fmt(r.grandTotal)}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                              <div
                                className="tbl-wrap"
                                style={{
                                  flex: 1,
                                  maxHeight: "calc(100vh - 280px)",
                                }}
                              >
                                <table>
                                  <thead>
                                    <tr>
                                      <th style={{ textAlign: "left" }}>Sl</th>
                                      <th
                                        className={`sortable${
                                          sortCol === "customerName"
                                            ? " sort-on"
                                            : ""
                                        }`}
                                        style={{ textAlign: "left" }}
                                        onClick={() =>
                                          toggleSort("customerName")
                                        }
                                      >
                                        Customer{" "}
                                        {sortCol === "customerName"
                                          ? sortDir === "asc"
                                            ? "↑"
                                            : "↓"
                                          : ""}
                                      </th>
                                      <th
                                        className={`sortable${
                                          sortCol === "wp" ? " sort-on" : ""
                                        }`}
                                        style={{ textAlign: "left" }}
                                        onClick={() => toggleSort("wp")}
                                      >
                                        WP{" "}
                                        {sortCol === "wp"
                                          ? sortDir === "asc"
                                            ? "↑"
                                            : "↓"
                                          : ""}
                                      </th>
                                      {WAREHOUSES.map((w) => (
                                        <th
                                          key={w.key}
                                          className={`sortable${
                                            sortCol === w.key ? " sort-on" : ""
                                          }`}
                                          onClick={() => toggleSort(w.key)}
                                        >
                                          {w.short}{" "}
                                          {sortCol === w.key
                                            ? sortDir === "asc"
                                              ? "↑"
                                              : "↓"
                                            : ""}
                                        </th>
                                      ))}
                                      <th
                                        className={`sortable${
                                          sortCol === "grandTotal"
                                            ? " sort-on"
                                            : ""
                                        }`}
                                        onClick={() => toggleSort("grandTotal")}
                                      >
                                        Total{" "}
                                        {sortCol === "grandTotal"
                                          ? sortDir === "asc"
                                            ? "↑"
                                            : "↓"
                                          : ""}
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {filteredRows.map((row, i) => (
                                      <tr
                                        key={`${row.customerName}_${row.wp}_${i}`}
                                        className="clickable"
                                        onClick={() => drillCustomer(row)}
                                      >
                                        <td>{row.slNo}</td>
                                        <td style={{ textAlign: "left" }}>
                                          <span
                                            style={{
                                              display: "flex",
                                              alignItems: "center",
                                              gap: 7,
                                            }}
                                          >
                                            <span
                                              style={{
                                                width: 7,
                                                height: 7,
                                                background:
                                                  P[row.slNo % P.length],
                                                borderRadius: 2,
                                                display: "inline-block",
                                                flexShrink: 0,
                                              }}
                                            />
                                            <span
                                              style={{
                                                color: "var(--text)",
                                                fontWeight: 500,
                                              }}
                                            >
                                              {row.customerName}
                                            </span>
                                          </span>
                                        </td>
                                        <td
                                          style={{
                                            textAlign: "left",
                                            fontFamily: "JetBrains Mono",
                                            fontSize: 11,
                                          }}
                                        >
                                          {row.wp}
                                        </td>
                                        {WAREHOUSES.map((w) => (
                                          <td
                                            key={w.key}
                                            className={
                                              row[w.key] === 0
                                                ? "td0"
                                                : row[w.key] > 50000
                                                ? "td-hi"
                                                : ""
                                            }
                                            style={{
                                              cursor:
                                                row[w.key] > 0 ? "pointer" : "",
                                            }}
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              if (row[w.key] > 0)
                                                drillCxW(row, w);
                                            }}
                                          >
                                            {row[w.key] === 0 ? (
                                              "—"
                                            ) : (
                                              <span
                                                style={{
                                                  fontFamily: "JetBrains Mono",
                                                  fontSize: 11,
                                                }}
                                              >
                                                {fmt(row[w.key])}
                                              </span>
                                            )}
                                          </td>
                                        ))}
                                        <td className="td-total">
                                          {fmt(row.grandTotal)}
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                  <tfoot>
                                    <tr>
                                      <td>—</td>
                                      <td style={{ textAlign: "left" }}>
                                        Grand Total
                                      </td>
                                      <td />
                                      {WAREHOUSES.map((w) => (
                                        <td
                                          key={w.key}
                                          style={{
                                            fontFamily: "JetBrains Mono",
                                            fontSize: 11,
                                          }}
                                        >
                                          {fmt(report.grandTotals?.[w.key])}
                                        </td>
                                      ))}
                                      <td
                                        style={{
                                          color: "var(--teal)",
                                          fontFamily: "JetBrains Mono",
                                        }}
                                      >
                                        {fmt(report.grandTotals?.overall)}
                                      </td>
                                    </tr>
                                  </tfoot>
                                </table>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* ═══════════════════════════════════════════════════
              INTELLIGENCE TAB
          ═══════════════════════════════════════════════════ */}
                        {tab === "intel" && (
                          <IntelligenceTab reports={reports} report={report} />
                        )}
                      </>
                    )}
                    {/* end drill.level===0 */}
                  </>
                )}
                {/* end report guard */}
              </div>
              {/* end .content */}
            </div>
            {/* end .canvas */}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
